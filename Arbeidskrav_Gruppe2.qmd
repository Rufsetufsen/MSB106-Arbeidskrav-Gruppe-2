---
title: "Arbeidskrav i Regional økonomi"
author: "Gruppe 2"
date: last-modified
date-format: "DD MMMM YYYY"
format: 
  pdf:
    number-sections: true
    geometry: 
      - bottom=25mm
      - left=25mm
      - right=25mm
      - top=30mm
language: 
    crossref-fig-title: "Figur"
---

```{r}
#| label: setup
#| message: false
#| warning: false
library(tidyverse)
library(readxl)
library(sf)
library(spdep)
library(writexl)
library(PxWebApiData)
library(modelsummary)
library(knitr)
library(lubridate)
library(flextable)
library(dplyr)
options(
  paged.print = FALSE,
  scipen = 999
  )
```

```{r}
#| eval: false
# Lage en bib fil for brukte R pakker 
# NB når denne blir kjørt slettes bib filen, og blir laget på nytt
# må da legge inn vanlige kilder på nytt
packs <- c(
  "knitr",
  "tidyverse",
  "lubridate",
  "PxWebApiData",
  "flextable",
  "dplyr"
  )
write_bib(
  packs,
  file = "ArbRef.bib"
  )
rm(packs)
```

```{r}
load("nor_knr24_vec.rdata")
load("newknr.rdata")
```

## Datainnhenting

Bruk den kommuneinndelingen som gjelder pr 1. januar 2026. Hent inn data for følgende variable:

### Folketall.

Tabell 07459 på nettsidene til Statistisk Sentralbyrå (SSB) gir for eksempel mulighet til å hente årlige befolkningsdata for kommuner tilbake til 1986.

```{r}
#| cache: true
beftot <- PxData12(
  "https://data.ssb.no/api/v0/no/table/07459/",
  Region = list("agg:KommSummer", knr24),
  Tid = as.character(1986:2025),
  Alder = list("agg:TodeltGrupperingB", c("H17", "H18"))) |> 
  select(Region, år, value) |> 
  group_by(Region, år) |> 
  summarise(beftot = sum(value), .groups = "drop") |> 
  rename(kommunenummer = Region) |> 
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |> 
  mutate(kommunenummer = str_sub(kommunenummer, 3, 6))
```

```{r}
#| cache: true
befendr <- PxData12(
  "https://data.ssb.no/api/v0/no/table/07459/",
  Region = list("agg:KommSummer", knr24),
  Tid = c("2000", "2025"),
  Alder = list("agg:TodeltGrupperingB", c("H17", "H18"))) |> 
  group_by(Region, år) |> 
  summarise(beftot = sum(value), .groups = "drop") |> 
  pivot_wider(
    names_prefix = "beftot",
    names_from = år,
    values_from = beftot
  ) |> 
  rename(kommunenummer = Region) |> 
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |> 
  mutate(kommunenummer = str_sub(kommunenummer, 3, 6)) |>
  mutate(bef_endrtot = (beftot2025/beftot2000)*100) |> 
  mutate(bef_endrtot = case_when(
    is.infinite(bef_endrtot) ~ 100,
    .default = bef_endrtot
  )) |>
  select(kommunenummer, bef_endrtot)
```

```{r}
bef <- left_join(beftot, befendr, by = join_by("kommunenummer"))
```

```{r}
save(bef, file = "bef.rdata")
```

### Demografiske data.

Tabell 07459 hos SSB gir også grunnlag for å finne befolkningen fordelt etter kjønn, og etter de alderskategoriene dere finner hensiktsmessig for analysen. Dette kan for eksempel være (0-19), (20-29), (30-45), (45-66), (67-) for å fange opp ulike faser i et livsløp.


### Sentralitetsindeksen for norske kommuner.

Data er lett tilgjengelige på nettsidene til SSB.
Gjør kort greie for beregningsgrunnlaget for indeksen.
Test videre om det har vært signifikante endringer i verdiene for indeksen for de årene dere har data (2017, 2020-2024), og diskuter kort mulige årsaker til eventuelle endringer.

```{r}
load("./data/nor_knr24_vec.rdata")
load("./data/newknr.rdata")
```


```{r}
#Leser av excel-filene
sentralitet2017 <-
  read_xlsx("./data/sentralitet 2017.xlsx")
sentralitet2020 <- 
  read_xlsx("./data/sentralitet 2020 kommuner.xlsx")
sentralitet2023 <-
  read_xlsx("./data/sentralitet 2023-2024 kommuner.xlsx")
# Slår sammen tabellene fra 2020/2023 slik at vi kan se utvikling. 
Sentralitet <-
  newknr %>%
  left_join(sentralitet2017, by = c("knr" = "Kommunenummer 2018"), keep = FALSE) %>%
  left_join(sentralitet2020, by = "knr", keep = FALSE) %>%
  left_join(sentralitet2023, by = c("knr2023" = "knr 2024"), keep = FALSE)%>%
  # Sammenligner sentralitetsindeks i 2020 og 2023.  
  mutate('Endring sentralitetsindeks 2020/2023' = `Indeks 2020` - `Indeks 2023`)
```

Sentralitetsindeksen er en kode som beskriver hver kommunes sentralitet. Beregningen av sentralitetsindeksen er basert på reisetid til arbeidsplasser og servicefunksjoner fra alle bebodde grunnkretser. Indeksen er sammensatt av to del-indekser: - Antall arbeidsplasser de som bor i den enkelte grunnkrets kan nå med bil i løpet av 90 minutter. - Hvor mange ulike typer servicefunksjoner (varer og tjenester) de som bor i den enkelte grunnkrets kan nå med bil i løpet av 90 minutter.

Antallet vektes, slik at en arbeidsplass eller servicefunksjon som ligger nært bostedet teller mer enn en som ligger lenger bort. Indeksen fordeles på en kontinuerlig skala fra 0 (minst sentral) til 1000 (mest sentral), og fordeles så inn i 6 forskjellige sentralitetsklasser, basert på kommunens sentralitetsverdi.

Endringer fra 2017 -> 2020 og 2024 skyldes (i følge SSB selv) i stor grad endringer i kommunegrensene. I perioden har det vært flere kommuneoppløsninger/sammenslåinger, og indeksen vil påvirkes ved hver slik grensejustering. 
I 2017 (ved første kalkulering av indeksen), ble det også gjort noen feil i databehandlingen som senere har blitt rettet opp i. Ved èn kjøring av dataeksport ble det satt en cutoff på antall arbeidsplasser den enkelte kunne nå innen 60 minutter i stedet for de 90 som indeksen skulle baseres på. Dette påvirket resultatet svært mye for de aktuelle områdene (Hordaland, Sogn og Fjordane, Møre og Romsdal, Trøndelag og Nord-Norge).

### Prosentvis arbeidsledighet.

Tabell 13563 på nettsidene til SSB gir informasjon om registrerte arbeidsledige i norske kommuner (velg Nivå 2 i kategoriseringen av Prioritert arbeidsstyrkestatus), og videre om antall i arbeidsstyrken (Nivå 1). Dette gir grunnlag for å beregne ledighetsprosenter for kommunene, men bare for årene 2008-2024. Det er ikke nødvendig å gå inn på alder og innvandringskategori i data. Dere finner også på nett 1 en NAV-tabell («Kommune. Beholdning måned. 1995-2024 (csv)»), som gir ledighetsprosenter for kommuner for perioden 1995-2024). Her kan det imidlertid bli nødvendig å gjøre justeringer både for kommuneinndeling og beregning av årsgjennomsnitt basert på månedsdata. Gjør kort greie for hvordan NAV og SSB bruker ulike definisjoner av arbeidsledighet.

#### Arbeidsledighet fra SSB
```{r}
SSb_Arbledig <- PxData12(
  "https://data.ssb.no/api/v0/no/table/13563/",
  Region = list("agg:KommSummer", knr24),
  Tid = as.character(2008:2024),
  HovArbStyrkStatus = c("A", "A.09"),
  Alder = "15+",
  InnvandrKat = "A-G") |>
  select(region, år, HovArbStyrkStatus, value) |>
  pivot_wider(
    names_from  = HovArbStyrkStatus,
    values_from = value
  ) |>
  rename(
    arbeidsstyrke = A,
    registrerte_ledige = `A.09`) |>
    mutate(
    prosent_arbledig = if_else(
    is.na(arbeidsstyrke) | arbeidsstyrke == 0,
    NA_real_,
    100 * registrerte_ledige / arbeidsstyrke))
```


#### Arbeidsledighet fra NAV
```{r}
# Tabellen har noen divverse NA verdier i tabellen
# Leser inn excel tabell NavTabell 1995-2024.xlsx
NAV <- read_excel("NavTabell 1995-2024.xlsx",
                  sheet = 1,
                  skip = 4,
                  col_types = "text")

# Gjør om Karakterer til Nummeriske tall
NAV <- NAV |>
  mutate(
    År = as.numeric(År),
    Kommunenr = as.numeric(Kommunenr)
  )

NAV <- NAV |>
  mutate(
    beholdning = as.numeric(Beholdning),
    andel = as.numeric(`Andel av arbeidsstyrken`)
  ) |>
  filter(Kommunenr != -1)

# Lager en ny tabell for å legge sammen månedene for hver kommune, hvert år og finner gjennomsnittstallet for året.
nav_aar <- NAV |>
  group_by(Kommunenr, Kommunenavn, År) |>
  summarise(
    prosent_ledige_i_året = mean(andel, na.rm = TRUE),
    antall_ledige_i_året = mean(beholdning, na.rm = TRUE),
    .groups = "drop"
  )

# Fjerner NAV tabellen for vi trenger den ikke mer.
 rm(NAV)
```
Arbeidsledighet kan defineres som andelen av et lands arbeidsstyrke som ikke er i arbeid, men som aktivt søker jobb og er tilgjengelig for å starte. I Norge publiserer både NAV og Statistik sentralbyrå (SSB) tall for arbeidsledighet, men bruker ulike metoder når det kommer til å samle inn data.
Kilde: https://arbeidsledighet.no/sporsmal-og-svar/

NAVs tall omfatter personer som er registrert som helt ledigh hos NAV. Dette er en fulltelling av alle som faktisk har meldt seg som arbeidssøkere i NAVs systemer. SSB derimot, måler arbeidsledighet gjennom Arbeidskraftundersøkelsen (AKU), som er en intervjuundersøkelse basert på et representativt utvalg av hele befolkningen.

Begge benytter de samme grunnleggende kriteriene for hva som regnes som arbeidsledihhet. Forskellen i tall skyldes først og fremst innsamlongsmetoden. SSB inkluderer også personer som er uten arbeid og aktivt søker jobb. Flere av disse kan være personer som ikke er registrert hos NAV. Dette fører til at SSB rapporterer et høyere ledighetstall enn NAV. 

NAVs tall gir derimot et bedre bilde av hvor mange som faktisk mottat og har behov for oppføring fra et statlig organ, mens SSBs tall gir et bredere og mer helhetlig bilde av arbeidsledigheten i befolkningen som helhet.

Kilde: https://www.ssb.no/arbeid-og-lonn/sysselsetting/artikler/hvorfor-ulike-arbeidsledighetstall

### Sysselsetting.

Tabell 03321 på nettsidene til SSB gir grunnlag for å finne antall arbeidsplasser i norske kommuner tilbake til år 2000, beregnet i 4. kvartal for hvert år. Velg sysselsatte personer etter arbeidsstedskommune. Bruk den kommuneinndelingen som gjelder i 2026.

### Gjennomsnittlig kvadratmeterpris for bolig.

Data for boligomsetninger finnes i Tabell 06035 på nettsidene til SSB.
Data er gitt for alle år i perioden 2002-2024, blant annet spesifisert for den kommuneinndelingen vi har hatt etter 2024.
Det kan være en god ide å hente informasjon både om eneboliger og leiligheter.
For en sammenligning på tvers av kommuner kan priser på eneboliger være mest relevant, blant annet siden det er liten omsetning av leiligheter i mange små kommuner.

### Utdanningsnivå.

Tabell 09429 på nettsidene til SSB gir en lang tidsserie for 1970-2024 for hvordan befolkningen er sammensatt etter 6 ulike utdanningsnivåer, etter kjønn, blant annet spesifisert for den kommuneinndelingen vi har hatt etter 2024.

```{r}
#| cache: true
utdan <- pxwebData12(
  "https://data.ssb.no/api/v0/no/table/09429/",
  Region = list("*"),
  Tid = as.character(c(1970, 1986:2024)),
  Nivaa = c("03a", "04a"),
  Kjonn = "0",
  ContentsCode = "Personer") |> 
  select(Region, år, nivå, Nivaa, Personer) |>
  rename(knr = Region)

utdan <- left_join(newknr, utdan, join_by(knr)) |>
  rename(kommunenummer = knr2023) |>
  group_by(kommunenummer, år) |>
  summarise(totutper = sum(Personer), .groups = "drop") |>
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |>
  left_join(beftot, join_by(kommunenummer, år)) |> 
  mutate(utdanand = totutper/beftot*100)
```

```{r}
save(utdan, file = "utdan.rdata")
```

### Ut- og innflyttinger pr 1000 innbyggere.

Informasjon om flyttestrømmer i perioden 2010-2024 finnes i Tabell 13255 på nettsidene til SSB. Data kan finnes blant annet for den kommuneinndelingen vi har hatt etter 2024. Ved å kombinere med data for folketall (se foran) kan en beregne flyttinger pr 1000 innbyggere, til sammenligning mellom kommunene. Kommunene kan videre kategoriseres etter om de har netto ut- eller innflytting, og en kan finne data for utflytting pr 1000 innbyggere for alderskategorien 18-29 år, og innflytting pr 1000 innbyggere for de som er 30 år eller eldre.

```{r}
#| cache: true
flyttper1000 <- pxwebData12(
  "https://data.ssb.no/api/v0/no/table/13255/",
  Region = list("*"),
  Tid = as.character(2010:2024),
  Alder = c("18-29", "30+")) |>
  select(Region, år, Alder, Innflytting, Utflytting) |> 
  rename(knr = Region,
         alder = Alder)

flyttper1000 <- left_join(newknr, flyttper1000, join_by(knr)) |>
  rename(kommunenummer = knr2023) |>
  group_by(kommunenummer, år, alder) |>
  summarise(innflytting = sum(Innflytting),
            utflytting = sum(Utflytting), 
            .groups = "drop") |>
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |>
  mutate(nettoflytt = innflytting - utflytting) |>
  left_join(beftot, join_by(kommunenummer, år)) |> 
  mutate(innper1000 = innflytting/beftot*1000,
         utper1000 = utflytting/beftot*1000,
         nettoflyttper1000 = innper1000 - utper1000) |>
  select(kommunenummer, år, alder, innper1000, utper1000, nettoflyttper1000)
```

```{r}
flyttkat <- pxwebData12(
  "https://data.ssb.no/api/v0/no/table/13255/",
  Region = list("*"),
  Tid = as.character(2010:2024),
  Alder = c("18-29", "30+")) |>
  select(Region, år, Innflytting, Utflytting) |> 
  rename(knr = Region)

flyttkat <- left_join(newknr, flyttkat, join_by(knr)) |>
  rename(kommunenummer = knr2023) |>
  group_by(kommunenummer, år) |>
  summarise(innflytting = sum(Innflytting),
            utflytting = sum(Utflytting), 
            .groups = "drop") |>
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |>
  left_join(beftot, join_by(kommunenummer, år)) |>
  mutate(totinnper1000 = innflytting/beftot*1000,
         totutper1000 = utflytting/beftot*1000,
         nettototflytt = totinnper1000 - totutper1000) |>
  select(kommunenummer, år, nettototflytt) |>
  mutate(kategori = ifelse(nettototflytt > 0, "inn_mest", "ut_mest")) |>
  select(-nettototflytt)
```

```{r}
flytt <- left_join(flyttper1000, flyttkat, by = join_by(kommunenummer, år))
```

```{r}
save(flytt, file = "flytt.rdata")
```

### Inn- og utpendling.

Innpendlingen kan gjerne måles pr 1000 arbeidsplasser i kommunen, dvs at en kombinerer data for samlet antall innpendlere i Tabell 03321 med data for sysselsetting i kommunen (etter arbeidssted). I anslag for utpendling pr 1000 arbeidstakere kombineres data om antall utpendlere med data for antall arbeidstakere (fra Tabell 03321, spesifisert etter bostedskommune). Anslag for antall arbeidstakere (etter bostedskommune) kan beregnes ut fra Tabell 03321. Denne tabellen kan videre brukes til å finne samlet antall pendlere ut fra kommunene og samlet antall pendlere inn til kommunene.


```{r}

#| warning: false

pendl <- pxwebData12(
  "11616",
  Region = list("*"),
  ContentsCode = c("Bosatt", "Innpendlere", "Utpendlere", "Arbeidssted"),
  Tid = as.character(2000:2024),
  Alder = "15-74"
)

```


```{r}

tip <- pendl |>
  select(knr = Region, år, Bosatt, Innpendlere, Utpendlere, Arbeidssted) |>
  left_join(newknr, join_by(knr)) |>
  group_by(knr24, år) |>
  summarise(Bosatt = sum(Bosatt),
      Innpendlere = sum(Innpendlere),
      Utpendlere = sum(Utpendlere),
      Arbeidssted = sum(Arbeidssted),
      .groups = "drop") |>
  filter(knr24 != "9999")
```

```{r}

```

