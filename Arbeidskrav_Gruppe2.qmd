---
title: "Arbeidskrav i Anvendt by- og regionaløkonomi"
author: "Gruppe 2"
format: html
editor: visual
---

## Datainnhenting

```{r}
load("nor_knr24_vec.rdata")
load("newknr.rdata")
```

```{r}
#| label: setup
#| message: false
#| echo: true
#| warning: false

library(tidyverse)
library(readxl)
library(sf)
library(spdep)
library(writexl)
library(PxWebApiData)
library(modelsummary)
```

### Folketall.

Tabell 07459 på nettsidene til Statistisk Sentralbyrå (SSB) gir for eksempel mulighet til å hente årlige befolkningsdata for kommuner tilbake til 1986.

```{r}
#| cache: true
# Total population: kommune x år  

beftot <- PxData12(
  "https://data.ssb.no/api/v0/no/table/07459/",
  Region = list("agg:KommSummer", knr24),
  Tid    = as.character(1986:2025),
  Alder  = list("agg:TodeltGrupperingB", c("H17", "H18"))
) |>
  select(Region, år, value) |>
  group_by(Region, år) |>
  summarise(beftot = sum(value), .groups = "drop") |>
  rename(kommunenummer = Region) |>
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |>
  mutate(kommunenummer = str_sub(kommunenummer, 3, 6))

# Befolkningsendring 1986–2025 (one row per kommune)

bef_endr <- beftot |>
  group_by(kommunenummer) |>
  summarise(
    beftot1986 = beftot[år == 1986][1],
    beftot2025 = beftot[år == 2025][1],
    bef_endrtot = if_else(
      !is.na(beftot1986) & beftot1986 > 0,
      (beftot2025 / beftot1986) * 100,
      NA_real_
    ),
    .groups = "drop"
  ) |>
  select(kommunenummer, bef_endrtot)

```

```{r}
#| cache: true
# Population by age groups: kommune x år x alder (long)

befald <- PxData12(
  "https://data.ssb.no/api/v0/no/table/07459/",
  Region = list("agg:KommSummer", knr24),
  Tid    = as.character(1986:2025),
  Alder  = list(
    "agg:TiAarigGruppering",
    c("F00-09", "F10-19", "F20-29", "F30-39", "F40-49",
      "F50-59", "F60-69", "F70-79", "F80-89", "F90-99", "F100G10+")
  )
) |>
  select(Region, år, alder, value) |>
  group_by(Region, år, alder) |>
  summarise(befald = sum(value), .groups = "drop") |>
  rename(kommunenummer = Region) |>
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |>
  mutate(kommunenummer = str_sub(kommunenummer, 3, 6))

```

```{r}
# Final dataset: kommune x år x alder

bef <- befald |>
  left_join(beftot, by = c("kommunenummer", "år")) |>
  left_join(bef_endr,    by = "kommunenummer")
```

### Demografiske data.

Tabell 07459 hos SSB gir også grunnlag for å finne befolkningen fordelt etter kjønn, og etter de alderskategoriene dere finner hensiktsmessig for analysen. Dette kan for eksempel være (0-19), (20-29), (30-45), (45-66), (67-) for å fange opp ulike faser i et livsløp.

```{r}
# demografiske mellom 1986 og 2025

demografiske_kjonn <- PxData12(
  "https://data.ssb.no/api/v0/no/table/07459/",
  Region = list("agg:KommSummer", knr24),
  Tid    = as.character(1986:2025),
  Kjonn  = c("1","2"),
  Alder  = list("agg:TiAarigGruppering",
                c("F00-09","F10-19","F20-29","F30-39","F40-49",
                  "F50-59","F60-69","F70-79","F80-89","F90-99","F100G10+"))
) |>
  select(Region, år, Kjonn, alder, value) |>
  mutate(
    kjønn = recode(as.character(Kjonn),
                   "1"="Menn","2"="Kvinner",
                   .default=as.character(Kjonn))
  ) |>
  group_by(Region, år, kjønn, alder) |>
  summarise(bef = sum(value, na.rm = TRUE), .groups = "drop") |>
  rename(kommunenummer = Region) |>
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |>
  mutate(kommunenummer = str_sub(kommunenummer, 3, 6)) |>
  select(kommunenummer, år, kjønn, alder, bef)

```

```{r}
# demografi etter aldersgruppe
demografi <- demografiske_kjonn |>
  mutate(
    aldersgruppe = case_when(
      alder %in% c("0-9 år", "10-19 år") ~ "0-19",
      alder == "20-29 år"               ~ "20-29",
      alder %in% c("30-39 år", "40-49 år") ~ "30-45",
      alder %in% c("50-59 år", "60-69 år") ~ "45-66",
      TRUE                               ~ "67+"
    )
  ) |>
  group_by(kommunenummer, år, kjønn, aldersgruppe) |>
  summarise(bef = sum(bef, na.rm = TRUE), .groups = "drop")

```

### Sentralitetsindeksen for norske kommuner.

Data er lett tilgjengelige på nettsidene til SSB. Gjør kort greie for beregningsgrunnlaget for indeksen. Test videre om det har vært signifikante endringer i verdiene for indeksen for de årene dere har data (2017, 2020-2024), og diskuter kort mulige årsaker til eventuelle endringer.




### Prosentvis arbeidsledighet.

Tabell 13563 på nettsidene til SSB gir informasjon om registrerte arbeidsledige i norske kommuner (velg Nivå 2 i kategoriseringen av Prioritert arbeidsstyrkestatus), og videre om antall i arbeidsstyrken (Nivå 1). Dette gir grunnlag for å beregne ledighetsprosenter for kommunene, men bare for årene 2008-2024. Det er ikke nødvendig å gå inn på alder og innvandringskategori i data. Dere finner også på nett 1 en NAV-tabell («Kommune. Beholdning måned. 1995-2024 (csv)»), som gir ledighetsprosenter for kommuner for perioden 1995-2024). Her kan det imidlertid bli nødvendig å gjøre justeringer både for kommuneinndeling og beregning av årsgjennomsnitt basert på månedsdata. Gjør kort greie for hvordan NAV og SSB bruker ulike definisjoner av arbeidsledighet.

```{r}

SSb_Arbledig <- PxData12(
  "https://data.ssb.no/api/v0/no/table/13563/",
  Region = list("agg:KommSummer", knr24),
  Tid = as.character(2008:2024),
  HovArbStyrkStatus = c("A", "A.09"),
  Alder = "15+",
  InnvandrKat = "A-G") |>
  select(region, år, HovArbStyrkStatus, value) |>
  pivot_wider(
  names_from  = HovArbStyrkStatus,
  values_from = value,
  values_fn   = ~sum(.x, na.rm = TRUE))|>
  rename(
    arbeidsstyrke      = A,
    registrerte_ledige = `A.09`
  ) |>
  mutate(
    prosent_arbledig = if_else(
      is.na(arbeidsstyrke) | arbeidsstyrke == 0,
      NA_real_,
      100 * registrerte_ledige / arbeidsstyrke
    )
  )

```
 

```{r}

# NA verdier har ikke blitt fjernet, hvis du lurte :)
# Leser inn excel tabell NavTabell 1995-2024.xlsx
NAV <- read_excel("NavTabell 1995-2024.xlsx",
                  sheet = 1,
                  skip = 4,
                  col_types = "text")

# Gjør om Karakterer til Nummeriske tall
NAV <- NAV |>
  mutate(
    År = as.numeric(År),
    Kommunenr = as.numeric(Kommunenr)
  )

NAV <- NAV |>
  mutate(
    beholdning = as.numeric(Beholdning),
    andel = as.numeric(`Andel av arbeidsstyrken`)
  ) |>
  filter(Kommunenr != -1)

# Lager et eget data for nav_aar, der en gjør om månedstall til ett gjennomsnittstall for hvert år i hver kommune.
nav_aar <- NAV |>
  group_by(Kommunenr, Kommunenavn, År) |>
  summarise(
    prosent_ledige_i_året = mean(andel, na.rm = TRUE),
    antall_ledige_i_året = mean(beholdning, na.rm = TRUE),
    .groups = "drop"
  )

# Sletter NAV grunnet til at de viktige tallene vi trenger ligger i nav_aar
 rm(NAV)
```

### Sysselsetting.

Tabell 03321 på nettsidene til SSB gir grunnlag for å finne antall arbeidsplasser i norske kommuner tilbake til år 2000, beregnet i 4. kvartal for hvert år. Velg sysselsatte personer etter arbeidsstedskommune. Bruk den kommuneinndelingen som gjelder i 2026.





### Gjennomsnittlig kvadratmeterpris for bolig.

Data for boligomsetninger finnes i Tabell 06035 på nettsidene til SSB. Data er gitt for alle år i perioden 2002-2024, blant annet spesifisert for den kommuneinndelingen vi har hatt etter 2024. Det kan være en god ide å hente informasjon både om eneboliger og leiligheter. For en sammenligning på tvers av kommuner kan priser på eneboliger være mest relevant, blant annet siden det er liten omsetning av leiligheter i mange små kommuner.

 
```{r}
# Hent metadata for tabell 06035
meta <- ApiData(
  "https://data.ssb.no/api/v0/no/table/06035/",
  returnMetaFrames = TRUE
)

# Finn alle kommuner (4-sifrede kommunenummer)
# Dette gir kommunenivå i gjeldende inndeling
kommune_values <- meta$Region |>
  transmute(kommunenummer = values) |>
  filter(str_detect(kommunenummer, "^\\d{4}$")) |>
  pull(kommunenummer)


# Hent boligomsetninger fra API
#    - År: 2002–2024
#    - Boligtype: Enebolig (01) og Leilighet (03)
#    - Variabel: Kvadratmeterpris
bolig <- ApiData12(
  "https://data.ssb.no/api/v0/no/table/06035/",
  Region = kommune_values,
  Tid = as.character(2002:2024),
  Boligtype = c("01", "03"),
  ContentsCode = "KvPris"
) |>
  select(Region, Tid, Boligtype, value) |>
  rename(
    kommunenummer = Region,
    år = Tid,
    kvpris = value
  ) |>
  mutate(
    boligtype_txt = case_when(
      Boligtype == "01" ~ "Enebolig",
      Boligtype == "03" ~ "Leilighet",
      TRUE ~ Boligtype
    )
  )|>
  filter(!is.na(kvpris))

```


### Utdanningsnivå.

Tabell 09429 på nettsidene til SSB gir en lang tidsserie for 1970-2024 for hvordan befolkningen er sammensatt etter 6 ulike utdanningsnivåer, etter kjønn, blant annet spesifisert for den kommuneinndelingen vi har hatt etter 2024.

```{r}

utdanning <- pxwebData12(
  "https://data.ssb.no/api/v0/no/table/09429/",
  Region = list("*"),
  Tid = as.character(c(1970, 1980:2024)),
  Nivaa = c("01", "02a", "11", "03a", "04a", "09a"), # 6 nivå
  Kjonn = c("1", "2"), # 1 er Menn，og 2 er Kvinner
  ContentsCode = "Personer"
) |> 
  select(Region, år, nivå, Nivaa, Kjonn, Personer) |>
  rename(knr = Region)
```

```{r}
utdanning <- left_join(newknr, utdanning, join_by(knr)) |>
  rename(kommunenummer = knr2023) |>
  filter(!is.na(kommunenummer)) |>
  group_by(kommunenummer, år, nivå, Nivaa, Kjonn) |>
  summarise(
    Personer = sum(Personer, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(
    Personer = if_else(Personer == 0, NA_real_, Personer)
  ) |>
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |>
  left_join(beftot, by = c("kommunenummer", "år")) |>
  mutate(
    utdanand = if_else(
      is.na(beftot) | beftot == 0 | is.na(Personer),
      NA_real_,
      100 * Personer / beftot
    )
  )|>
  filter(
    !is.na(Personer),
    !is.na(beftot),
    !is.na(utdanand)
  )

```


### Ut- og innflyttinger pr 1000 innbyggere.

Informasjon om flyttestrømmer i perioden 2010-2024 finnes i Tabell 13255 på nettsidene til SSB. Data kan finnes blant annet for den kommuneinndelingen vi har hatt etter 2024. Ved å kombinere med data for folketall (se foran) kan en beregne flyttinger pr 1000 innbyggere, til sammenligning mellom kommunene. Kommunene kan videre kategoriseres etter om de har netto ut- eller innflytting, og en kan finne data for utflytting pr 1000 innbyggere for alderskategorien 18-29 år, og innflytting pr 1000 innbyggere for de som er 30 år eller eldre.

```{r}
#| warning: false
flyttper1000 <- pxwebData12(
  "https://data.ssb.no/api/v0/no/table/13255/",
  Region = list("*"),
  Tid = as.character(2010:2024),
  Alder = c("18-29", "30+")) |>
  select(Region, år, Alder, Innflytting, Utflytting) |> 
  rename(knr = Region,
         alder = Alder)
```


```{r}
flyttper1000 <- left_join(newknr, flyttper1000, join_by(knr)) |>
  rename(kommunenummer = knr2023) |>
  group_by(kommunenummer, år, alder) |>
  summarise(innflytting = sum(Innflytting),
            utflytting = sum(Utflytting), 
            .groups = "drop") |>
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |>
  mutate(nettoflytt = innflytting - utflytting) |>
  left_join(beftot, join_by(kommunenummer, år)) |> 
  mutate(innper1000 = innflytting/beftot*1000,
         utper1000 = utflytting/beftot*1000,
         nettoflyttper1000 = innper1000 - utper1000) |>
  select(kommunenummer, år, alder, innper1000, utper1000, nettoflyttper1000)
```

```{r}
#| warning: false
flyttkat <- pxwebData12(
  "https://data.ssb.no/api/v0/no/table/13255/",
  Region = list("*"),
  Tid = as.character(2010:2024),
  Alder = c("18-29", "30+")) |>
  select(Region, år, Innflytting, Utflytting) |> 
  rename(knr = Region)

flyttkat <- left_join(newknr, flyttkat, join_by(knr)) |>
  rename(kommunenummer = knr2023) |>
  group_by(kommunenummer, år) |>
  summarise(innflytting = sum(Innflytting),
            utflytting = sum(Utflytting), 
            .groups = "drop") |>
  filter(!kommunenummer %in% c("K-21-22", "K-23", "K-Rest")) |>
  left_join(beftot, join_by(kommunenummer, år)) |>
  mutate(totinnper1000 = innflytting/beftot*1000,
         totutper1000 = utflytting/beftot*1000,
         nettototflytt = totinnper1000 - totutper1000) |>
  select(kommunenummer, år, nettototflytt) |>
  mutate(kategori = ifelse(nettototflytt > 0, "inn_mest", "ut_mest")) |>
  select(-nettototflytt)
```

```{r}
flytt <- left_join(flyttper1000, flyttkat, by = join_by(kommunenummer, år))
```



### Inn- og utpendling.

Innpendlingen kan gjerne måles pr 1000 arbeidsplasser i kommunen, dvs at en kombinerer data for samlet antall innpendlere i Tabell 03321 med data for sysselsetting i kommunen (etter arbeidssted). I anslag for utpendling pr 1000 arbeidstakere kombineres data om antall utpendlere med data for antall arbeidstakere (fra Tabell 03321, spesifisert etter bostedskommune). Anslag for antall arbeidstakere (etter bostedskommune) kan beregnes ut fra Tabell 03321. Denne tabellen kan videre brukes til å finne samlet antall pendlere ut fra kommunene og samlet antall pendlere inn til kommunene.

```{r}
#| warning: false
pendl <- pxwebData12(
  "11616",
  Region = list("*"),
  ContentsCode = c("Bosatt", "Innpendlere", "Utpendlere", "Arbeidssted"),
  Tid = as.character(2000:2024),
  Alder = "15-74"
) |>
  pivot_longer(
    cols = c(Bosatt, Innpendlere, Utpendlere, Arbeidssted),
    names_to = "ContentsCode",
    values_to = "value"
  )
```

```{r}
# Aggregerer tallene over kjønn ved å summere menn (Kjonn = 1)
# og kvinner (Kjonn = 2), slik at vi får tall for begge kjønn
pendl_begge <- pendl |>
  mutate(
    Region = as.character(Region),
    år  = as.integer(år)
  ) |>
  # Beholder kun observasjoner for menn og kvinner
  filter(Kjonn %in% c(1, 2)) |>
  group_by(Region, år, ContentsCode) |>
  # Summerer over kjønn ved å gruppere på kommune, år og innhold
  summarise(
    antall = sum(value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  # Gir innholdsvariabelen et mer beskrivende navn
  rename(situasjon = ContentsCode)

```
 

```{r}
#  Gjør datasettet bredt slik at hver situasjon
#  (Bosatt, Arbeidssted, Innpendlere, Utpendlere) blir en egen kolonne

pendl_begge <- pendl_begge |>
  pivot_wider(
    names_from  = situasjon,
    values_from = antall
  )
```

 
```{r}
# Beregner indikatorene som etterspørres i oppgaven
pendl_per1000 <- pendl_begge |>
  mutate(
    # Innpendling pr 1000 arbeidsplasser i kommunen
    innpend_per1000_arbpl = ifelse(Arbeidssted > 0,
                                   Innpendlere / Arbeidssted * 1000,
                                   NA_real_),

    # Utpendling pr 1000 arbeidstakere (bosatt i kommunen)
    utpend_per1000_bosatt = ifelse(Bosatt > 0,
                                   Utpendlere / Bosatt * 1000,
                                   NA_real_),

    # (valgfritt) netto pendling
    pendlingsbalanse = Innpendlere - Utpendlere
  ) |>
  select(
    Region, år,
    Bosatt, Arbeidssted, Innpendlere, Utpendlere,
    innpend_per1000_arbpl, utpend_per1000_bosatt,
    pendlingsbalanse
  )
```

 









