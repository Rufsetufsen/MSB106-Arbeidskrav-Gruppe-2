---
title: "Arbeidskrav i Regional økonomi"
author: "Gruppe 2"
institute: "HVL"
date: last-modified
date-format: "dddd D MMM, YYYY"
abstract: ""
number-sections: true
number-depth: 3
lang: NO_nb
csl: apa7.csl
crossref:
  fig-prefix: figur
  tbl-prefix: tabell
  fig-title: Figur
  tbl-title: Tabell
  lof-title: "Figurliste"
  lot-title: "Tabelliste"
format:
  html: default
  typst:
    papersize: a4
    toc: true
    toc-title: Innholdsfortegnelse
    documentclass: article
    number-sections: true
    keep-tex: true
    fig-pos: "H"
    output-file: "Arbeidskrav_Gruppe2"
    citeproc: true
  pdf:
    documentclass: article
    toc:  true
    toc-title: Innholdsfortegnelse
    number-sections: true
    keep-tex: true
    papersize: A4
    fig-pos: "H"
    output-file: "Arbeidskrav_Gruppe2"
editor_options:
  markdown:
    wrap: 72
    canonical: true
    chunk_output_type: console
echo: false
eval: true
bibliography: ArbRef.bib
nocite: '@*'
---

```{r}
#| label: setup
#| message: false
#| warning: false
library(tidyverse)
library(readxl)
library(sf)
library(spdep)
library(writexl)
library(PxWebApiData)
library(modelsummary)
library(knitr)
library(lubridate)
library(flextable)
library(dplyr)
library(janitor)
library(fixest)
options(
  paged.print = FALSE,
  scipen = 999
  )
```

```{r}
#| eval: false
# Lage en bib fil for brukte R pakker 
# NB når denne blir kjørt slettes bib filen, og blir laget på nytt
# må da legge inn vanlige kilder på nytt
packs <- c(
  "knitr",
  "tidyverse",
  "readxl",
  "sf",
  "spdep",
  "writexl",
  "modelsummary",
  "lubridate",
  "PxWebApiData",
  "flextable",
  "dplyr"
  )
write_bib(
  packs,
  file = "ArbRef.bib"
  )
rm(packs)
```

```{r}
load("nor_knr24_vec.rdata")
load("newknr.rdata")
load("bef.rdata")
load("demografi.rdata")
load("demografi_total.rdata")
load("bolig.rdata")
load("utdanning.rdata")
load("flytt.rdata")
load("pendl.rdata")
load("Sentralitet.rdata")
load("arbledighet.rdata")
load("syss.rdata")
load("syssendr0024.rdata")
```

# Innledning

# Datainnhenting

Denne studien benytter kommunevise paneldata for å analysere
sammenhenger mellom sentralitet, demografi, arbeidsmarked, boligmarked
og flyttemønstre i norske kommuner. Nedenfor gis en kort redegjørelse
for de enkelte datasettene og deres rolle i de videre deskriptive og
analytiske analysene.

## Folketall

Folketall er en sentral variabel i analysen av regional utvikling og
brukes både som utfallsvariabel og som skaleringsgrunnlag for andre
størrelser. I den deskriptive delen analyseres prosentvis
folketallsvekst etter 2000 gjennom kartframstillinger og tidsserier for
ulike sentralitetskategorier. Videre inngår folketallsutvikling som
avhengig variabel i regresjonsanalysene, der formålet er å undersøke
hvordan arbeidsmarked, boligpriser, utdanningsnivå, flytting og pendling
samvarierer med endringer i befolkningen.

## Demografiske data

Demografiske data, særlig alderssammensetningen i befolkningen, brukes
til å analysere selektiv flytting og regionale livsløp. Spesiell vekt
legges på aldersgruppen 20–29 år, som ofte er mest mobil. Andelen unge
voksne inngår i kartframstillinger, tidsserier og korrelasjonsanalyser.

## Sentralitetsindeksen for norske kommuner

Sentralitetsindeksen brukes som en overordnet strukturell
forklaringsvariabel i analysen. Indeksen ligger til grunn for gruppering
av kommuner i den deskriptive delen og brukes videre i
korrelasjonsanalyser.

Sentralitetsindeksen er en kode som beskriver hver kommunes sentralitet.
Beregningen av sentralitetsindeksen er basert på reisetid til
arbeidsplasser og servicefunksjoner fra alle bebodde grunnkretser.
Indeksen er sammensatt av to del-indekser:

-   Antall arbeidsplasser de som bor i den enkelte grunnkrets kan nå med
    bil i løpet av 90 minutter.
-   Hvor mange ulike typer servicefunksjoner (varer og tjenester) de som
    bor i den enkelte grunnkrets kan nå med bil i løpet av 90 minutter.

Antallet vektes, slik at en arbeidsplass eller servicefunksjon som
ligger nært bostedet teller mer enn en som ligger lenger bort. Indeksen
fordeles på en kontinuerlig skala fra 0 (minst sentral) til 1000 (mest
sentral), og fordeles så inn i 6 forskjellige sentralitetsklasser,
basert på kommunens sentralitetsverdi.

Endringer fra 2017 -\> 2020 og 2024 skyldes (i følge SSB selv) i stor
grad endringer i kommunegrensene . I perioden har det vært flere
kommuneoppløsninger/sammenslåinger, og indeksen vil påvirkes ved hver
slik grensejustering [@høydahl, s. 22]. I 2017 (ved første kalkulering
av indeksen), ble det også gjort noen feil i databehandlingen som senere
har blitt rettet opp i. Ved èn kjøring av dataeksport ble det satt en
cutoff på antall arbeidsplasser den enkelte kunne nå innen 60 minutter i
stedet for de 90 som indeksen skulle baseres på. Dette påvirket
resultatet svært mye for de aktuelle områdene (Hordaland, Sogn og
Fjordane, Møre og Romsdal, Trøndelag og Nord-Norge).

## Prosentvis arbeidsledighet

Arbeidsledighet benyttes som indikator på arbeidsmarkedets tilstand i
kommunene. Variabelen inngår i kartframstillinger, tidsserier og
korrelasjonsanalyser.

Arbeidsledighet kan defineres som andelen av et lands arbeidsstyrke som
ikke er i arbeid, men som aktivt søker jobb og er tilgjengelig for å
starte. I Norge publiserer både NAV og Statistik sentralbyrå (SSB) tall
for arbeidsledighet, men bruker ulike metoder når det kommer til å samle
inn data. [@erikherstadhorgen2025]

NAVs tall omfatter personer som er registrert som helt ledigh hos NAV.
Dette er en fulltelling av alle som faktisk har meldt seg som
arbeidssøkere i NAVs systemer. SSB derimot, måler arbeidsledighet
gjennom Arbeidskraftundersøkelsen (AKU), som er en intervjuundersøkelse
basert på et representativt utvalg av hele befolkningen.

Begge benytter de samme grunnleggende kriteriene for hva som regnes som
arbeidsledihhet. Forskellen i tall skyldes først og fremst
innsamlongsmetoden. SSB inkluderer også personer som er uten arbeid og
aktivt søker jobb. Flere av disse kan være personer som ikke er
registrert hos NAV. Dette fører til at SSB rapporterer et høyere
ledighetstall enn NAV.

NAVs tall gir derimot et bedre bilde av hvor mange som faktisk mottat og
har behov for oppføring fra et statlig organ, mens SSBs tall gir et
bredere og mer helhetlig bilde av arbeidsledigheten i befolkningen som
helhet. [@statistisksentralbyrå2025]

```{r}
#Leser av excel-filene
sentralitet2017 <-
  read_xlsx("./data/sentralitet 2017.xlsx")
sentralitet2020 <- 
  read_xlsx("./data/sentralitet 2020 kommuner.xlsx")
sentralitet2023 <-
  read_xlsx("./data/sentralitet 2023-2024 kommuner.xlsx")
# Slår sammen tabellene fra 2020/2023 slik at vi kan se utvikling. 
Sentralitet <-
  newknr %>%
  left_join(sentralitet2017, by = c("knr" = "Kommunenummer 2018"), keep = FALSE) %>%
  left_join(sentralitet2020, by = "knr", keep = FALSE) %>%
  left_join(sentralitet2023, by = c("knr24" = "knr 2024"), keep = FALSE)%>%
  # Sammenligner sentralitetsindeks i 2020 og 2023.  
  mutate('Endring sentralitetsindeks 2020/2023' = `Indeks 2020` - `Indeks 2023`) %>%
  rename(kommunenummer = knr24)
  save(Sentralitet, file = "Sentralitet.rdata")
```

## Sysselsetting

Sysselsettingsdata brukes til å analysere lokal næringsutvikling og
arbeidsplassvekst, og inngår både som avhengig og forklaringsvariabel i
analysene.

## Gjennomsnittlig kvadratmeterpris for bolig

Boligpriser benyttes som mål på etterspørsel og attraktivitet i
regionale boligmarkeder. Prisene sier også noe om tilbudet i regionale
boligmarkeder. Variabelen inngår i kart, tidsserier og
regresjonsanalyser.

## Utdanningsnivå

Utdanningsnivå brukes som indikator på kommunenes humankapital og
analyseres i sammenheng med sentralitet, sysselsetting og boligpriser.

## Ut- og innflyttinger pr 1000 innbyggere

Flyttedataene brukes til å analysere demografisk dynamikk og kommunenes
attraktivitet, inkludert netto flytting og aldersspesifikke flytterater.

## Inn- og utpendling

Pendlerdata brukes til å analysere funksjonelle arbeidsmarkedsregioner
og samspillet mellom bosted og arbeidssted.

# Resultater

## Kart

### Folketallsvekst

![Prosentvis folketallsvekst etter år
2000](Data/Prosentvis_folketallsvekst_etter_år_2000.png){#fig-BefolkningVekstKart}

Den prosentvise folketallsveksten etter år 2000, til 2024, kan ses i
@fig-BefolkningVekstKart. Her kan man se at det er ett fåtall kommuner
som har klasse 6 eller høyere. Der er flere kommuner i Akershus med
forholdsvis høy befolkningsvekts, for eksempel Gjerdrum, Nannestad og
Eidsvoll. Ullensaker har hatt høyest vekst i landet. Kystområdene sør i
landet har generelt sett hatt høyere vekst enn innlandet og Nord-Norge.
De kommunene med lavest vekst ligger for det meste i Trøndelag og lengre
nord i landet.

### Andel befolkning i alder 20-29

![Andel befolkning i alder 20-29 i
2024](./data/Andel_befolkning_i_alder_20-29_i_2024.png){#fig-Andelbef}

I @fig-Andelbef vises andel av befolkningen i aldersgruppen 20-29 i
2024. Her er det høyest andel i Troms, og en del plasser i Finnmark har
høy andel i aldersgruppen. Noen kommuner i landet har en spesielt høy
andel (18%). Det er spesielt de kommunene som er populære studiesteder,
e.g. Oslo, Trondheim og Bergen, som har en høy andel i denne
aldersgruppen.

### Arbeidsledighet og sysselsettingsvekst

![Andel arbeidsledighet i år
2024](./data/Andel_arbeidsledighet_i_år_2024.png){#fig-Arbledighet}

![Prosentvis sysselsettingsvekst etter år 2000. De tre første klassene
viser til negativ vekst, resten viser positiv
vekst](./data/Prosentvis_sysselsettingsvekst_etter_år_2000.png){#fig-SysselVekst}

@Fig-Arbledighet viser et kart over arbeidsledigheten i Norge i 2024.
Kartet viser få uteliggere med høy arbeidsledighet. Høyest
arbeidsledighet er i Finnmark, men man kan finne en uteligger i
Nordland. Det er også mer arbeidsledighet i området rundt og i Akershus
enn vest i landet. Arbeidsledighet er størst i urbane områder, og lavest
i rurale. Dette kan komme av “amenities”, eller “lokale goder”, som gjør
at det er mer ettertraktet å være boende i urbane områder. Videre i
@fig-SysselVekst kan man se prosentvis sysselsettingsvekst etter år
2000, til 2024. Her kan man se at det har både vært negativ og positiv
vekt i landet. Igjen kommer kystområdene i Sør-Norge, samt områdene
rundt og i Oslo godt ut, og har en høy klasse vekst. Innlandet og
nordover i landet har en del negativ vekst. Hamarøy skiller seg spesielt
ut og har klasse 10 vekst, selv om nabo kommunene har svak eller negativ
vekst.

### Andel med universitetsutdanning

![Andelen av innbyggerne med universitetsutdanning i
2024](./data/Andelen_av_innbyggerne_med_universitetsutdanning_i_2024.png){#fig-Universitetand}

Andelen av innbyggere med universitetsutdanning i 2024 kan ses i
@fig-Universitetand. Her er det blant annet en høy andel i området i og
rundt Oslo. Det er flere kommuner med forholdsvis lav andel (under
17,8%), men de fleste kommunene har en andel over den første klassen.
Urbane områder har høyere andel med universitetsutdanning enn i mer
rurale områder, for eksempel i indre strøk.

### Netto utflytting

![Netto utflytting per 1000 innbyggere. Røde kategorier viser til netto
utflytting, mens blåe viser til netto innflytting. Skravete kommuner
mangler
data](Data/Netto_utflytting_per_1000_innbyggere.png){#fig-Utflytting}

I @fig-Utflytting kan man se netto utflytting per 1000 innbyggere. Det
er mer kommunner med netto innflytting enn utflytting. Noen kommuner har
spesielt høy utflytting, for eksempel Engerdal, Vang og Snåsa. Det at
det er mer kommuner med en netto innflytting kan komme av innvandring.
Dette kunne det ha vært interessant å se nærmere på i videre studier.
Videre hadde det vært interessant å dele opp kartet i ulike
aldersgrupper for å se om vi kan se noen generelle mønstre, for eksempel
studenter sine flyttingsmønstre.

### Netto innpendling og kvm. pris for eneboliger

![Netto innpendling per 1000 arbeidsplasser. Røde verdier viser til
netto utpendling, og blåe til netto
innpendling](./data/Netto_innpendling_per_1000_arbeidsplasser.png){#fig-Pendlingarb}

![Gjennomsnittlig kvm. pris for eneboliger i 2024. Kommuner uten verdier
er
skravert](./data/Gjennomsnittlig_kvm._pris_for_eneboliger_i_2024.png){#fig-KvmprisEne}

Netto pendling per 1000 arbeidsplasser vises i @fig-Pendlingarb. Det er
mest høyest grad av utpendling i Østlandet, spesielt i Akershus. Det er
minst kommuner med mer innpendling enn utpendling, disse kommunene er
spredt over hele landet. Noen av disse kommunene er derimot rett
vedsiden av kommunene med mest utpendling, som tyder på at arbeiderne
pendler mye til nabokommunene. @Fig-KvmprisEne viser den
gjennomsnittlige kvadratmeter prisen for eneboliger i 2024. Det er en
del manglende data for priser. I og rundt Oslo er det spesielt høy pris
per kvm. Det samme gjelder blant annet for noen kommuner nord i Norge.
Man kan se at det er høyere priser ved kysten enn midt i landet. Det er
en generell trend med høyere boligpriser i urbane enn rurale områder.
Den høye innpendlingen i Oslo kan være ett resultat av den høye
kvadratmeterprisen for eneboliger.

## Kurver

```{r}
# Laster inn rdata-filene vi skal bruke til å lage kurver.
load("bolig2.rdata")
```

### Gjennomsnittlig folketall per sentralitetsklasse

```{r, warning=FALSE, message=FALSE}
# Merge bef med sentralitet
bef_merged <- bef %>%
  left_join(Sentralitet %>% select(knr, `Klasse 2023`), 
            by = c("kommunenummer" = "knr"))

# Gjennomsnittlig folketall per sentralitetsklasse - med facets (for lesbarhet)
bef_snitt <- bef_merged %>%
  filter(år > 2000) %>%
  filter(!is.na(`Klasse 2023`)) %>%  # Manglende parentes her
  mutate(år = as.numeric(as.character(år))) %>%  # Konverter år til numerisk
  group_by(år, `Klasse 2023`) %>%
  summarise(gjsnitt_folketall = mean(beftot, na.rm = TRUE),
            .groups = "drop")

ggplot(bef_snitt, aes(x = år, y = gjsnitt_folketall)) +
  geom_line(linewidth = 1, color = "steelblue") +
  geom_point(size = 2, color = "steelblue") +
  facet_wrap(~ `Klasse 2023`, 
             scales = "free_y",
             labeller = labeller(`Klasse 2023` = c(  # Manglende parentes her
               "1" = "Klasse 1 (mest sentral)",
               "2" = "Klasse 2",
               "3" = "Klasse 3",
               "4" = "Klasse 4",
               "5" = "Klasse 5",
               "6" = "Klasse 6 (minst sentral)"
             ))) +
  scale_x_continuous(breaks = seq(2000, 2025, by = 5)) +
  labs(title = "Folketallsutvikling etter sentralitetskategori",
       subtitle = "Gjennomsnittlig folketall per kommune, 2001-",
       x = "År",
       y = "Gjennomsnittlig folketall") +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1))
```

Folketallsutviklingen ser ut til å være lignende for de tre mest
sentrale sentralitetskategoriene. I klasse 4 ser vi en lignende, dog
svakere utvikling med et betraktelig hopp i folketall fra 2019 til 2020.
I klasse 5 var det befolkningsnedgang fra år 2000, før det snudde til
positiv utvikling rundt år 2007. Denne utviklingen snudde til det
negative igjen rundt 2016, før vi igjen ser et hopp i år 2020. De aller
minst sentrale kommunene har konsekvent hatt befolkningsnedgang siden
2000, foruten et hopp i 2020 og en mild oppgang de siste 2-3 årene.
Hoppet i 2020 skyldes kommunereformen. De minste kommunene (i folketall)
ble slått sammen for å spare på administrative utgifter, og det er
derfor vi ser størst hopp i folketall i de tre minst sentrale
kommunekategoriene i denne perioden. Den svake oppgangen i tiden etter
er interessant. Kan det være normalisering av hjemmekontor og økt fokus
på distriktsutvikling som driver denne desentraliseringen?\

### Andel innbyggere 20-29 år etter sentralitetskategori

```{r, warning=FALSE, message=FALSE}
# Merge aldersdata med sentralitetsdata
demo_merged <- demografi_total %>%
  mutate(år = as.numeric(as.character(år))) %>%
  left_join(Sentralitet %>% select(knr, `Klasse 2023`), 
            by = c("kommunenummer" = "knr"))%>%
  filter(!is.na(`Klasse 2023`))

# Beregne totalt folketall per kommune per år (for å regne ut andeler)
demo_totalt <- demo_merged %>%
  filter(år > 2000) %>%
  group_by(kommunenummer, år, `Klasse 2023`) %>%
  summarise(totalt_bef = sum(bef, na.rm = TRUE),
            .groups = "drop")

# Merge tilbake og beregne andeler
demo_andeler <- demo_merged %>%
  filter(år > 2000) %>%
  left_join(demo_totalt, by = c("kommunenummer", "år", "Klasse 2023")) %>%
  mutate(andel = bef / totalt_bef * 100)

# Kun aldersgruppen 20-29
demo_snitt_20_29 <- demo_andeler %>%
  filter(aldersgruppe == "20-29") %>%
  group_by(år, `Klasse 2023`) %>%
  summarise(gjsnitt_andel = mean(andel, na.rm = TRUE),
            .groups = "drop")

# Lage graf
ggplot(demo_snitt_20_29, aes(x = år, y = gjsnitt_andel)) +
  geom_line(linewidth = 1, color = "steelblue") +
  geom_point(size = 2, color = "steelblue") +
  facet_wrap(~ `Klasse 2023`, 
             scales = "free_y",
             labeller = labeller(`Klasse 2023` = c(
               "1" = "Klasse 1 (mest sentral)",
               "2" = "Klasse 2",
               "3" = "Klasse 3",
               "4" = "Klasse 4",
               "5" = "Klasse 5",
               "6" = "Klasse 6 (minst sentral)"
             ))) +
  scale_x_continuous(breaks = seq(2000, 2025, by = 5)) +
  labs(title = "Andel innbyggere 20-29 år etter sentralitetskategori",
       subtitle = "Gjennomsnittlig andel per kommune, 2001-",
       x = "År",
       y = "Andel av befolkningen (%)") +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))
```

Andel innbyggere i 20-årene ser ut til å følge en noenlunde lik
utvikling nasjonalt, unntatt for sentralitetsklasse 1 og 2 som har hatt
en svakere nedgang i unge innbyggere enn resten av landet. Dette kan
stemme overens med antagelsen om at unge mennesker trekkes mot urbane
miljø.

### Arbeidsledighet etter sentralitetskategori

```{r, warning=FALSE, message=FALSE}
aled_merged <- arbledighet %>%
  mutate(år = as.numeric(as.character(år))) %>%
  left_join(Sentralitet %>% select(knr, `Klasse 2023`), 
            by = c("kommunenummer" = "knr"))%>%
  filter(!is.na(`Klasse 2023`))

# Beregne gjennomsnittlig arbeidsledighet per sentralitetsklasse per år (etter 2008)
aled_snitt <- aled_merged %>%
  filter(år > 2008) %>%
  group_by(år, `Klasse 2023`) %>%
  summarise(gjsnitt_ledighet = mean(prosent_ledige_i_året, na.rm = TRUE),
            .groups = "drop")

# Lage graf - alle klasser i samme plot
ggplot(aled_snitt, aes(x = år, y = gjsnitt_ledighet, 
                        color = factor(`Klasse 2023`),
                        group = `Klasse 2023`)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(2009, 2025, by = 2)) +
  scale_color_discrete(name = "Sentralitetsklasse",
                       labels = c("1 (mest sentral)", "2", "3", "4", "5", "6 (minst sentral)")) +
  labs(title = "Arbeidsledighet etter sentralitetskategori",
       subtitle = "Gjennomsnittlig prosent arbeidsledige per kommune, 2009-",
       x = "År",
       y = "Arbeidsledighet (%)") +
  theme_minimal() +
  theme(legend.position = "right")
```

I figuren over ser vi en grafisk framstilling av gjennomsnittlig
arbeidsledighet (i prosent) i hver sentralitetskategori.
Arbeidsledigheten ser ut til å være relativt lik over hele landet, med
mindre enn ett prosentpoeng variasjon frem til 2020. I koronaåret 2020
ser vi en eksplosjon i ledighet for alle klassene, men med størst økning
i sentrale strøk. Sjokket fra COVID-19 ser ut til å ha gitt seg i 2022,
og grafen trender mot likevektsledighet igjen i 2023. Datagrunnlaget
viser at flere kommuner har oppgitt 0% arbeidsledighet i 2024, og vi
antar at dette er en feil i statistikken.

### Sysselsettingsvekst etter sentralitetskategori

```{r, warning=FALSE, message=FALSE}
# Merge sysselsettingdata med sentralitetsdata
syss_merged <- syss %>%
  mutate(år = as.numeric(as.character(år))) %>%
  left_join(Sentralitet %>% select(knr, `Klasse 2023`), 
            by = c("kommunenummer" = "knr"))%>%
  filter(!is.na(`Klasse 2023`))

# Beregne totalt antall sysselsatte per sentralitetsklasse per år
syss_totalt <- syss_merged %>%
  filter(år > 2000) %>%
  group_by(år, `Klasse 2023`) %>%
  summarise(totalt_sysselsatte = sum(Arbeidssted, na.rm = TRUE),
            .groups = "drop")

# Beregne prosentvis vekst år til år
syss_vekst <- syss_totalt %>%
  arrange(`Klasse 2023`, år) %>%
  group_by(`Klasse 2023`) %>%
  mutate(vekst_prosent = (totalt_sysselsatte - lag(totalt_sysselsatte)) / lag(totalt_sysselsatte) * 100) %>%
  ungroup() %>%
  filter(!is.na(vekst_prosent))  # Fjerner første år (ingen vekst å beregne)

# Lage graf - alle klasser i samme plot
ggplot(syss_vekst, aes(x = år, y = vekst_prosent, 
                        color = factor(`Klasse 2023`),
                        group = `Klasse 2023`)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_x_continuous(breaks = seq(2000, 2025, by = 3)) +
  scale_color_discrete(name = "Sentralitetsklasse",
                       labels = c("1 (mest sentral)", "2", "3", "4", "5", "6 (minst sentral)")) +
  labs(title = "Sysselsettingsvekst etter sentralitetskategori",
       subtitle = "Prosentvis endring fra forrige år, 2001-",
       x = "År",
       y = "Sysselsettingsvekst (%)") +
  theme_minimal() +
  theme(legend.position = "right")
```

Figuren over viser sysselsettingsvekts. Vi ser positiv utvikling i de
fleste årene, unntatt negativ utvikling i 2009, 2015 og 2020. Dette kan
ses i forbindelse med internasjonale økonomiske trender. Nedgangen i
2009 kan forklares som en konsekvens av "the great recession" i 2008.
Nedgangen i 2015 kan vi forbinde med oljekrisen i 2014 da tusenvis av
nordmenn mistet jobbene sine i oljeindustrien som følge av et ras i
oljeprisen. Kyst-Norge er sterkt knyttet opp til oljeindustrien, og
ringvirkningene av dette oljeprisfallet kunne dermed føles sterkt også i
andre industrier i landet. Nedgangen i 2020 må ses i forbindelse med
koronapandemien.

### Kvadratmeterpris bolig

```{r, warning=FALSE, message=FALSE}
# Merge boligdata med sentralitetsdata
bolig_merged <- bolig2 %>%
  mutate(år = as.numeric(as.character(år))) %>%
  left_join(Sentralitet %>% select(knr, `Klasse 2023`), 
            by = c("kommunenummer" = "knr")) %>%
  filter(!is.na(`Klasse 2023`))

# Beregne vektet gjennomsnittlig kvadratmeterpris per sentralitetsklasse per år (etter 2002)
# Vektes med antall omsetninger
bolig_vektet <- bolig_merged %>%
  filter(år > 2002) %>%
  group_by(år, `Klasse 2023`) %>%
  summarise(vektet_kvpris = sum(kvpris * antall_omsetninger, na.rm = TRUE) / 
                            sum(antall_omsetninger, na.rm = TRUE),
            .groups = "drop")

# Lage graf - alle klasser i samme plot
ggplot(bolig_vektet, aes(x = år, y = vektet_kvpris, 
                          color = factor(`Klasse 2023`),
                          group = `Klasse 2023`)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(2003, 2025, by = 3)) +
  scale_y_continuous(labels = scales::comma) +
  scale_color_discrete(name = "Sentralitetsklasse",
                       labels = c("1 (mest sentral)", "2", "3", "4", "5", "6 (minst sentral)")) +
  labs(title = "Utviklingen i kvadratmeterpriser for boliger etter sentralitetskategori",
       subtitle = "Vektet gjennomsnitt (alle boligtyper), 2003-",
       x = "År",
       y = "Kvadratmeterpris (kr)") +
  theme_minimal() +
  theme(legend.position = "right")
```

```{r, warning=FALSE, message=FALSE}
# Vektet pris per boligtype
bolig_vektet_type <- bolig_merged %>%
  filter(år > 2002) %>%
  group_by(år, `Klasse 2023`, boligtype_txt) %>%
  summarise(vektet_kvpris = sum(kvpris * antall_omsetninger, na.rm = TRUE) / 
                            sum(antall_omsetninger, na.rm = TRUE),
            .groups = "drop")

ggplot(bolig_vektet_type, aes(x = år, y = vektet_kvpris, 
                               color = factor(`Klasse 2023`),
                               linetype = boligtype_txt,
                               group = interaction(`Klasse 2023`, boligtype_txt))) +
  geom_line(linewidth = 1) +
  geom_point(size = 1.5) +
  scale_x_continuous(breaks = seq(2003, 2025, by = 3)) +
  scale_y_continuous(labels = scales::comma) +
  scale_color_discrete(name = "Sentralitetsklasse",
                       labels = c("1 (mest sentral)", "2", "3", "4", "5", "6 (minst sentral)")) +
  scale_linetype_discrete(name = "Boligtype") +
  labs(title = "Utviklingen i kvadratmeterpriser for boliger etter sentralitetskategori",
       subtitle = "Vektet gjennomsnitt etter boligtype, 2003-",
       x = "År",
       y = "Kvadratmeterpris (kr)") +
  theme_minimal() +
  theme(legend.position = "right")
```

Kvadratmeterprisen på bolig har hatt en positiv utvikling over hele
landet, men den har vært aller sterkest i de mest sentrale kommunene.
Det er ellers interessant å se at kvadratmeterprisen ser ut til å
korreleres med sentralitet.

### Utvikling i utdanning

```{r, warning=FALSE, message=FALSE}
# Merge utdanningsdata med sentralitetsdata
utd_merged <- utdanning %>%
  mutate(år = as.numeric(as.character(år))) %>%
  left_join(
    Sentralitet %>% 
      select(knr, `Klasse 2023`) %>%
      distinct(knr, .keep_all = TRUE),  # Tar kun første forekomst av hver kommune
    by = c("kommunenummer" = "knr")
  ) %>%
  filter(!is.na(`Klasse 2023`)) %>%
  filter(!is.infinite(utdanand))

# Beregne gjennomsnittlig andel per sentralitetsklasse per år
utd_snitt <- utd_merged %>%
  group_by(år, `Klasse 2023`) %>%
  summarise(gjsnitt_andel = mean(utdanand, na.rm = TRUE),
            .groups = "drop")

# Lage graf - alle klasser i samme plot
ggplot(utd_snitt, aes(x = år, y = gjsnitt_andel, 
                       color = factor(`Klasse 2023`),
                       group = `Klasse 2023`)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(1985, 2025, by = 5)) +
  scale_color_discrete(name = "Sentralitetsklasse",
                       labels = c("1 (mest sentral)", "2", "3", "4", "5", "6 (minst sentral)")) +
  labs(title = "Andel innbyggere med universitetsutdanning etter sentralitetskategori",
       subtitle = "Gjennomsnittlig andel per kommune (kort + lang), 1986-",
       x = "År",
       y = "Andel med universitetsutdanning (%)") +
  theme_minimal() +
  theme(legend.position = "right")

```

Utviklingen i andel høyt utdannede innbyggere har vært positiv
nasjonalt, men også her ser det ut til å korreleres med sentralitet. De
mest sentrale kommunene har også høyest andel høyt utdannede innbyggere.
Dette kan skyldes at befolkningen i bynære miljø har enklest tilgang til
universiteter og høyskoler, men det kan også være en indikasjon på at
det i bykommunene det er best tilgang på arbeid som krever høye
kvalifikasjoner. \### Utvikling i netto innflytting

```{r, warning=FALSE, message=FALSE}
flytt_merged <- flytt %>%
  mutate(år = as.numeric(as.character(år))) %>%
  left_join(
    Sentralitet %>% 
      select(knr, `Klasse 2023`) %>%
      distinct(knr, .keep_all = TRUE),
    by = c("kommunenummer" = "knr")
  ) %>%
  filter(!is.na(`Klasse 2023`))

# Beregne netto utflytting (negativt nettoflytt = utflytting)
# Beregne gjennomsnitt per sentralitetsklasse per år (etter 2010)
flytt_snitt <- flytt_merged %>%
  filter(år > 2010) %>%
  mutate(netto_utflytt = -nettoflyttper1000) %>%  # Gjør om til utflytting (positiv verdi = netto utflytting)
  group_by(år, `Klasse 2023`) %>%
  summarise(gjsnitt_netto_utflytt = mean(netto_utflytt, na.rm = TRUE),
            .groups = "drop")

# Lage fasettert graf
ggplot(flytt_snitt, aes(x = år, y = gjsnitt_netto_utflytt)) +
  geom_line(linewidth = 1, color = "steelblue") +
  geom_point(size = 2, color = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  facet_wrap(~ `Klasse 2023`, 
             scales = "free_y",
             labeller = labeller(`Klasse 2023` = c(
               "1" = "Klasse 1 (mest sentral)",
               "2" = "Klasse 2",
               "3" = "Klasse 3",
               "4" = "Klasse 4",
               "5" = "Klasse 5",
               "6" = "Klasse 6 (minst sentral)"
             ))) +
  scale_x_continuous(breaks = seq(2011, 2025, by = 3)) +
  labs(title = "Netto utflytting etter sentralitetskategori",
       subtitle = "Gjennomsnittlig netto utflytting per kommune, 2011-",
       x = "År",
       y = "Netto utflytting (antall personer)") +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))
```

Grafene over må tydes med at negative tall viser positiv flyttebalanse
(altså mer innflytning enn utflytning).

### Utvikling i netto innpendling

```{r, warning=FALSE, message=FALSE}
pendl_merged <- pendl %>%
  mutate(år = as.numeric(as.character(år))) %>%
  left_join(
    Sentralitet %>% 
      select(knr, `Klasse 2023`) %>%
      distinct(knr, .keep_all = TRUE),
    by = c("kommunenummer" = "knr")
  ) %>%
  filter(!is.na(`Klasse 2023`))

# Beregne gjennomsnittlig netto innpendling per sentralitetsklasse per år (etter 2000)
pendl_snitt <- pendl_merged %>%
  filter(år > 2000) %>%
  group_by(år, `Klasse 2023`) %>%
  summarise(gjsnitt_nettopend = mean(nettopend, na.rm = TRUE),
            .groups = "drop")

# Lage fasettert graf
ggplot(pendl_snitt, aes(x = år, y = gjsnitt_nettopend)) +
  geom_line(linewidth = 1, color = "steelblue") +
  geom_point(size = 2, color = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  facet_wrap(~ `Klasse 2023`, 
             scales = "free_y",
             labeller = labeller(`Klasse 2023` = c(
               "1" = "Klasse 1 (mest sentral)",
               "2" = "Klasse 2",
               "3" = "Klasse 3",
               "4" = "Klasse 4",
               "5" = "Klasse 5",
               "6" = "Klasse 6 (minst sentral)"
             ))) +
  scale_x_continuous(breaks = seq(2001, 2025, by = 5)) +
  labs(title = "Netto innpendling etter sentralitetskategori",
       subtitle = "Gjennomsnittlig netto innpendling per kommune, 2001-",
       x = "År",
       y = "Netto innpendling (antall personer)") +
  theme_minimal() +
  theme(strip.text = element_text(face = "bold"))
```

Grafene over viser netto innpendling etter sentralitetskategori. Vi ser
at for alle sentralitetsklassene utenom 1 og 2 har vi negativ
gjennomsnittsinnpendlig per kommune, altså vil det være flere arbeidere
som pendler ut fra kommunene enn pendler inn. Ett av målene for
sentralitetsindeksen er nemlig antall arbeidsplasser innenfor rimelig
pendleavstand (90 minutter) vektet etter nærhet. Det er dermed logisk at
det pendles mer inn til de mest sentrale kommunene.

## Korrelasjoner

Det vil bli tatt en korrelasjons beregning mellom ulike variabler med de
dataene vi har tilgjengelig fra SSB. Dataene fra året 2014 og året 2023
vil bli trukket frem for å beregne korrelasjonen mellom de variablene
for norske kommuner. Sentralitet derimot har vi tilgjengelig data fra
2018, 2020 og 2023, og det blitt valgt å ta data fra 2018 og vil i de
beregningene bruke årene 2018 og 2023. På de beregningene som viser
størst forskjeller eller tall som stikker ut, vil bli kommentert på og
gitt en mer forklaring på hvorfor vi får det resultatet.

```{r}
# Hjelpefunksjoner (standardisering av rensing + generell korrelasjon)

# Fyller ut kommunenummer til 4-sifret streng
std_k <- function(df, k = kommunenummer) {
  df %>%
    mutate({{ k }} := str_pad(as.character({{ k }}), 4, "left", "0"))}

# Gjør år om til heltall (for å unngå problemer ved join)
std_year <- function(df, year = år) {
  df %>%
    mutate({{ year }} := as.integer({{ year }}))}

# Generelt: beregn korrelasjon gruppert på år
cor_by_year <- function(df, x, y, year = år) {
  df %>%
    group_by({{ year }}) %>%
    summarise(cor = cor({{ x }}, {{ y }}, use = "complete.obs"), .groups = "drop") %>%
    arrange({{ year }})}

```

```{r}
# Ofte brukte mellomdatasett (beregnes en gang og gjenbrukes i flere join)

# Andel 20–29 år + folketall (brukes svært ofte videre)
andel_20_29 <- demografi_total %>%
  std_k(kommunenummer) %>%
  std_year(år) %>%
  summarise(
    folketall = sum(bef, na.rm = TRUE),
    bef_20_29 = sum(bef[aldersgruppe == "20-29"], na.rm = TRUE),
    .by = c(kommunenummer, år)
  ) %>%
  mutate(andel_20_29 = bef_20_29 / folketall) %>%
  select(kommunenummer, år, folketall, andel_20_29)

# Sentralitet: lag langt format (kommunenummer, år, indeks)
sent_long <- Sentralitet %>%
  rename(indeks_2018 = 'Sentralitetsindeks 2018') |>
  clean_names() %>%
  select(kommunenummer, indeks_2018, indeks_2020, indeks_2023) %>%
  std_k(kommunenummer) %>%
  summarise(
    indeks_2018 = if (all(is.na(indeks_2018))) NA_real_ else max(indeks_2018, na.rm = TRUE),
    indeks_2020 = if (all(is.na(indeks_2020))) NA_real_ else max(indeks_2020, na.rm = TRUE),
    indeks_2023 = if (all(is.na(indeks_2023))) NA_real_ else max(indeks_2023, na.rm = TRUE),
    .by = kommunenummer
  ) %>%
  pivot_longer(
    cols = starts_with("indeks_"),
    names_to = "år",
    values_to = "indeks"
  ) %>%
  mutate(år = readr::parse_number(år)) %>%
  select(kommunenummer, år, indeks)

# Arbeidsledighet: standardiser variabelnavn til ledig
ledig <- arbledighet %>%
  std_k(kommunenummer) %>%
  std_year(år) %>%
  transmute(kommunenummer, år, ledig = prosent_arbledig) %>%
  filter(!is.na(ledig))


# Enebolig kvadratmeterpris
kvpris_ene <- bolig %>%
  std_k(kommunenummer) %>%
  std_year(år) %>%
  filter(boligtype_txt == "Enebolig") %>%
  summarise(
    kvpris = mean(kvpris, na.rm = TRUE),
    .by = c(kommunenummer, år)
  )

# Høyere utdanning (kort + lang slått sammen til "andel_hoyere")
andel_hoyere <- utdanning %>%
  std_k(kommunenummer) %>%
  std_year(år) %>%
  summarise(
    andel_hoyere = sum(utdanand, na.rm = TRUE),
    .by = c(kommunenummer, år)
  )

# Flytting: utflytting/innflytting/netto (per 1000 – mean-aggregert er som regel mest robust)
flytt_std <- flytt %>%
  std_k(kommunenummer) %>%
  std_year(år) %>%
  summarise(
    utflytt_per1000     = mean(utper1000, na.rm = TRUE),
    innflytt_per1000    = mean(innper1000, na.rm = TRUE),
    nettoflytt_per1000  = mean(nettoflyttper1000, na.rm = TRUE),
    .by = c(kommunenummer, år)
  )

# Pendling per 1000: innpendling/utpendling + pendlingsbalanse (netto)
pendl_std <- pendl %>%
  std_k(kommunenummer) %>%
  std_year(år) %>%
  summarise(
    Innpendlere     = mean(Innpendlere, na.rm = TRUE),
    Utpendlere      = mean(Utpendlere, na.rm = TRUE),
    nettopend    = mean(nettopend, na.rm = TRUE),
    .by = c(kommunenummer, år)
  )
```

Folketall mot andel i aldersgruppen 20-29

```{r}
cor_folk_2013_2023 <- andel_20_29 %>%
  filter(år %in% c(2014, 2023)) %>%
  cor_by_year(folketall, andel_20_29)
cor_folk_2013_2023
```

Sentralitet mot andel i aldersgruppen 20-29

```{r}
cor_sent_2020_2023 <- andel_20_29 %>%
  filter(år %in% c(2018, 2023)) %>%
  left_join(sent_long, by = c("kommunenummer", "år")) %>%
  cor_by_year(indeks, andel_20_29)
cor_sent_2020_2023
```

Sentralitet mot arbeidsledighet

```{r}
cor_ledig_2020_2023 <- ledig %>%
  filter(år %in% c(2018, 2023)) %>%
  left_join(sent_long, by = c("kommunenummer", "år")) %>%
  cor_by_year(indeks, ledig)
cor_ledig_2020_2023
```

Sentralitet mot enebolig kvm.pris

```{r}
cor_bolig_2020_2023 <- kvpris_ene %>%
  filter(år %in% c(2018, 2023)) %>%
  left_join(sent_long, by = c("kommunenummer", "år")) %>%
  cor_by_year(indeks, kvpris)
cor_bolig_2020_2023
```

Sentralitet mot andel med høyere utdanning

```{r}
cor_utd_2020_2023 <- andel_hoyere %>%
  filter(år %in% c(2018, 2023)) %>%
  left_join(sent_long, by = c("kommunenummer", "år")) %>%
  cor_by_year(indeks, andel_hoyere)
cor_utd_2020_2023
```

Sentralitet mot utflytting

```{r}
cor_utflytt_2020_2023 <- flytt_std %>%
  filter(år %in% c(2018, 2023)) %>%
  left_join(sent_long, by = c("kommunenummer", "år")) %>%
  cor_by_year(indeks, utflytt_per1000)
cor_utflytt_2020_2023
```

Sentralitet mot innpendling

```{r}
cor_innpend_2020_2023 <- pendl_std %>%
  filter(år %in% c(2018, 2023), !is.na(Innpendlere)) %>%
  left_join(sent_long, by = c("kommunenummer", "år")) %>%
  cor_by_year(indeks, Innpendlere)
cor_innpend_2020_2023
```

Sentralitet mot utpendling

```{r}
cor_utpend_2020_2023 <- pendl_std %>%
  filter(år %in% c(2018, 2023), !is.na(Utpendlere)) %>%
  left_join(sent_long, by = c("kommunenummer", "år")) %>%
  cor_by_year(indeks, Utpendlere)
cor_utpend_2020_2023
```

Ledig mot andel i aldersgruppen 20-29

```{r}
cor_ledig_andel20_29_2013_2023 <- andel_20_29 %>%
  filter(år %in% c(2014, 2023)) %>%
  left_join(ledig, by = c("kommunenummer", "år")) %>%
  cor_by_year(ledig, andel_20_29)
cor_ledig_andel20_29_2013_2023
```

Ledig mot enebolig kvm.pris

```{r}
cor_ledig_bolig_2013_2023 <- kvpris_ene %>%
  filter(år %in% c(2014, 2023)) %>%
  left_join(ledig, by = c("kommunenummer", "år")) %>%
  cor_by_year(ledig, kvpris)
cor_ledig_bolig_2013_2023
```

Ledig vs andel med høyere utdanning

```{r}
cor_ledig_utd_2013_2023 <- andel_hoyere %>%
  filter(år %in% c(2014, 2023)) %>%
  left_join(ledig, by = c("kommunenummer", "år")) %>%
  cor_by_year(ledig, andel_hoyere)
cor_ledig_utd_2013_2023
```

Ledig mot utflytting per 1000

```{r}
cor_ledig_flytt_2013_2023 <- flytt_std %>%
  filter(år %in% c(2014, 2023)) %>%
  left_join(ledig, by = c("kommunenummer", "år")) %>%
  mutate(
    utflytt_per1000     = if_else(is.finite(utflytt_per1000), utflytt_per1000, NA_real_),
    nettoflytt_per1000  = if_else(is.finite(nettoflytt_per1000), nettoflytt_per1000, NA_real_),
    ledig               = if_else(is.finite(ledig), ledig, NA_real_)
  ) %>%
  group_by(år) %>%
  summarise(
    cor_brutto = cor(ledig, utflytt_per1000, use = "complete.obs"),
    cor_netto  = cor(ledig, nettoflytt_per1000, use = "complete.obs"),
    .groups = "drop"
  ) %>%
  arrange(år)

cor_ledig_flytt_2013_2023

```

Ledig mot pendling per 1000

```{r}
cor_ledig_utpend_2013_2023 <- pendl_std %>%
  filter(år %in% c(2013, 2023)) %>%
  left_join(ledig, by = c("kommunenummer", "år")) %>%
  group_by(år) %>%
  summarise(
    cor_brutto = cor(ledig, Utpendlere, use = "complete.obs"),
    cor_netto  = cor(ledig, nettopend, use = "complete.obs"),
    .groups = "drop"
  ) %>%
  arrange(år)
cor_ledig_utpend_2013_2023
```

Bolig kvm.pris mot andel med høyere utdanning

```{r}
cor_bolig_utd_2013_2023 <- kvpris_ene %>%
  filter(år %in% c(2013, 2023)) %>%
  left_join(andel_hoyere, by = c("kommunenummer", "år")) %>%
  cor_by_year(kvpris, andel_hoyere)
cor_bolig_utd_2013_2023
```

Bolig kvm.pris mot andel i aldersgruppen 20-29

```{r}
cor_bolig_andel20_29_2013_2023 <- kvpris_ene %>%
  filter(år %in% c(2013, 2023)) %>%
  left_join(andel_20_29, by = c("kommunenummer", "år")) %>%
  cor_by_year(kvpris, andel_20_29)
cor_bolig_andel20_29_2013_2023
```

Bolig kvm.pris mot innpendling

```{r}
cor_bolig_innpend_2013_2023 <- kvpris_ene %>%
  filter(år %in% c(2013, 2023)) %>%
  left_join(pendl_std %>% select(kommunenummer, år, Innpendlere),
            by = c("kommunenummer", "år")) %>%
  cor_by_year(kvpris, Innpendlere)
cor_bolig_innpend_2013_2023
```

Bolig kvmpris mot utpendling

```{r}
cor_bolig_utpend_2013_2023 <- kvpris_ene %>%
  filter(år %in% c(2013, 2023)) %>%
  left_join(pendl_std %>% select(kommunenummer, år, Utpendlere),
            by = c("kommunenummer", "år")) %>%
  cor_by_year(kvpris, Utpendlere)
cor_bolig_utpend_2013_2023
```

Bolig kvm.pris mot utflytting

```{r}
cor_bolig_utflytt_2013_2023 <- kvpris_ene %>%
  filter(år %in% c(2013, 2023)) %>%
  left_join(flytt_std %>% select(kommunenummer, år, utflytt_per1000),
            by = c("kommunenummer", "år")) %>%
  cor_by_year(kvpris, utflytt_per1000)
cor_bolig_utflytt_2013_2023
```

Bolig kvm.pris mot innflytting

```{r}
cor_bolig_innflytt_2013_2023 <- kvpris_ene %>%
  filter(år %in% c(2013, 2023)) %>%
  left_join(flytt_std %>% select(kommunenummer, år, innflytt_per1000),
            by = c("kommunenummer", "år")) %>%
  cor_by_year(kvpris, innflytt_per1000)
cor_bolig_innflytt_2013_2023
```

Nettoflytting mot andel i aldersgruppen 20-29

```{r}
cor_nettoflytt_andel20_29_2013_2023 <- flytt_std %>%
  filter(år %in% c(2013, 2023)) %>%
  left_join(andel_20_29, by = c("kommunenummer", "år")) %>%
  cor_by_year(nettoflytt_per1000, andel_20_29)
cor_nettoflytt_andel20_29_2013_2023
```

Nettoflytting mot netto utpendling

```{r}
cor_nettoflytt_netto_utpend_2013_2023 <- flytt_std %>%
  filter(år %in% c(2013, 2023)) %>%
  left_join(pendl_std %>% select(kommunenummer, år, nettopend),
            by = c("kommunenummer", "år")) %>%
  cor_by_year(nettoflytt_per1000, nettopend)
cor_nettoflytt_netto_utpend_2013_2023

```

Netto utpendling og bolig kvm.pris i tilgrensende kommuner

```{r}
dsn <- "WFS:https://wfs.geonorge.no/skwms1/wfs.inspire-au?service=WFS"

# Kommunegrenser + naboskap
sf::sf_use_s2(FALSE)

kommune_sf <- st_read(dsn, layer = "au:AdministrativeUnit", quiet = TRUE) %>%
  rename(kommunenummer = nationalCode) %>%
  mutate(kommunenummer = stringr::str_pad(as.character(kommunenummer), 4, "left", "0")) %>%
  st_make_valid()

nb <- spdep::poly2nb(kommune_sf, queen = TRUE)

# Lag edge-list i (kommune) -> j (nabo), og map til kommunenummer
knr <- kommune_sf$kommunenummer
edges_knr <- dplyr::bind_rows(lapply(seq_along(nb), function(i) {
  j <- nb[[i]]
  if (length(j) == 0) return(NULL)
  tibble::tibble(kommunenummer = knr[i], nabo_knr = knr[j])
})) %>%
  dplyr::distinct()

# Enebolig kvpris per kommune-år (unik) + nabo-gjennomsnitt
kvpris_ene <- bolig %>%
  mutate(
    kommunenummer = stringr::str_pad(as.character(kommunenummer), 4, "left", "0"),
    år = as.integer(år)
  ) %>%
  filter(boligtype_txt == "Enebolig") %>%
  summarise(kvpris = mean(kvpris, na.rm = TRUE), .by = c(kommunenummer, år)) %>%
  mutate(kvpris = dplyr::if_else(is.finite(kvpris), kvpris, NA_real_))

kvpris_nabo_mean <- edges_knr %>%
  left_join(kvpris_ene, by = c("nabo_knr" = "kommunenummer")) %>%
  summarise(kvpris_nabo_mean = mean(kvpris, na.rm = TRUE), .by = c(kommunenummer, år))

# Koble til netto utpendling og beregn korrelasjon
cor_netto_utpend_nabo_kvpris_2013_2023 <- pendl_std %>%
  select(kommunenummer, år, nettopend) %>%
  left_join(kvpris_nabo_mean, by = c("kommunenummer", "år")) %>%
  filter(år %in% c(2013, 2023)) %>%
  summarise(
    cor = cor(nettopend, kvpris_nabo_mean, use = "complete.obs"),
    .by = år
  ) %>%
  arrange(år)
cor_netto_utpend_nabo_kvpris_2013_2023

```

## Paneldata SKRIV EN FORKLARING PÅ HVER PANEL

### Årlig endring i folketall og sysselsetting

```{r}
folk_syss_panel <- demografi_total %>%
  std_k(kommunenummer) %>%
  std_year(år) %>%
  summarise(
    folketall = sum(bef, na.rm = TRUE),
    .by = c(kommunenummer, år)
  ) %>%
  left_join(
    syss %>%
      std_k(kommunenummer) %>%
      std_year(år) %>%
      select(kommunenummer, år, syss = Arbeidssted),
    by = c("kommunenummer", "år")
  ) %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  mutate(
    d_folketall = folketall - lag(folketall),
    d_syss      = syss - lag(syss)
  ) %>%
  ungroup()

cor_folk_syss <- folk_syss_panel %>%
  group_by(kommunenummer) %>%
  summarise(
    n_obs = sum(complete.cases(d_folketall, d_syss)),
    cor_folk_syss = {
      if (n_obs >= 2) {
        cor(d_folketall, d_syss, use = "complete.obs")
      } else {
        NA_real_
      }
    },
    .groups = "drop"
  )

cor_folk_syss


cor_folk_syss %>%
  summarise(
    n_komm = n(),
    mean = mean(cor_folk_syss, na.rm = TRUE),
    median = median(cor_folk_syss, na.rm = TRUE),
    sd = sd(cor_folk_syss, na.rm = TRUE),
    min = min(cor_folk_syss, na.rm = TRUE),
    max = max(cor_folk_syss, na.rm = TRUE),
    n_na = sum(is.na(cor_folk_syss))
  )



```

### Årlig endring i prosentvis arbeidsledighet og årlig prosentvis endring i sysselsetting

```{r}

ledig_syss_panel <- ledig %>%
  left_join(
    syss %>%
      std_k(kommunenummer) %>%
      std_year(år) %>%
      select(kommunenummer, år, syss = Arbeidssted),
    by = c("kommunenummer", "år")
  ) %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  mutate(
    d_ledig = ledig - lag(ledig),
    g_syss_pct = 100 * (syss / lag(syss) - 1)
  ) %>%
  ungroup()

# Korrelasjon per kommune 
cor_ledig_syss <- ledig_syss_panel %>%
  group_by(kommunenummer) %>%
  summarise(
    n_obs = sum(complete.cases(d_ledig, g_syss_pct)),
    sd_ledig = sd(d_ledig, na.rm = TRUE),
    sd_syss  = sd(g_syss_pct, na.rm = TRUE),

    cor_ledig_syss = {
      if (n_obs >= 2 && sd_ledig > 0 && sd_syss > 0) {
        cor(d_ledig, g_syss_pct, use = "complete.obs")
      } else {
        NA_real_
      }
    },
    .groups = "drop"
  )

cor_ledig_syss


```

### Årlig endring i boligpriser og årlig netto innflytting

```{r}

bolig_flytt_panel <- kvpris_ene %>%
  std_k(kommunenummer) %>%
  std_year(år) %>%
  select(kommunenummer, år, kvpris) %>%
  filter(is.finite(kvpris)) %>%
  inner_join(
    flytt_std %>%
      std_k(kommunenummer) %>%
      std_year(år) %>%
      select(kommunenummer, år, nettoflytt_per1000) %>%
      filter(is.finite(nettoflytt_per1000)),
    by = c("kommunenummer", "år")
  ) %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  mutate(
    d_kvpris     = kvpris - lag(kvpris),
    d_nettoflytt = nettoflytt_per1000 - lag(nettoflytt_per1000)
  ) %>%
  ungroup()

bolig_flytt_diff <- bolig_flytt_panel %>%
  filter(is.finite(d_kvpris), is.finite(d_nettoflytt))

cor_bolig_nettoflytt <- bolig_flytt_diff %>%
  group_by(kommunenummer) %>%
  summarise(
    n_obs = n(),
    sd_kvpris = sd(d_kvpris, na.rm = TRUE),
    sd_flytt  = sd(d_nettoflytt, na.rm = TRUE),
    cor_bolig_nettoflytt = {
      if (n_obs >= 2 && sd_kvpris > 0 && sd_flytt > 0) {
        cor(d_kvpris, d_nettoflytt, use = 'complete.obs')
      } else {
        NA_real_
      }
    },
    .groups = "drop"
  )

cor_bolig_nettoflytt

```

### Årlig prosentvis endring i sysselsetting og årlig endring i boligpriser

```{r}

syss_bolig_panel <- syss %>%
  std_k(kommunenummer) %>%
  std_year(år) %>%
  select(kommunenummer, år, syss = Arbeidssted) %>%
  filter(is.finite(syss)) %>%
  inner_join(
    kvpris_ene %>%
      std_k(kommunenummer) %>%
      std_year(år) %>%
      select(kommunenummer, år, kvpris) %>%
      filter(is.finite(kvpris)),
    by = c("kommunenummer", "år")
  ) %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  mutate(
    g_syss_pct = 100 * (syss / lag(syss) - 1),  # prosentvis endring i sysselsetting
    d_kvpris   = kvpris - lag(kvpris)           # årlig endring i boligpriser
  ) %>%
  ungroup()

syss_bolig_diff <- syss_bolig_panel %>%
  filter(is.finite(g_syss_pct), is.finite(d_kvpris))

cor_syss_bolig <- syss_bolig_diff %>%
  group_by(kommunenummer) %>%
  summarise(
    n_obs = n(),
    sd_syss  = sd(g_syss_pct, na.rm = TRUE),
    sd_kvpris = sd(d_kvpris, na.rm = TRUE),
    cor_syss_bolig = {
      if (n_obs >= 2 && sd_syss > 0 && sd_kvpris > 0) {
        cor(g_syss_pct, d_kvpris, use = 'complete.obs')
      } else {
        NA_real_
      }
    },
    .groups = "drop"
  )

cor_syss_bolig

```

### Årlig endring i innpendling og årlig prosentvis endring i sysselsetting

```{r}

pendl_syss_panel <- pendl_std %>%
  std_k(kommunenummer) %>%
  std_year(år) %>%
  select(kommunenummer, år, Innpendlere) %>%
  filter(is.finite(Innpendlere)) %>%
  inner_join(
    syss %>%
      std_k(kommunenummer) %>%
      std_year(år) %>%
      select(kommunenummer, år, syss = Arbeidssted) %>%
      filter(is.finite(syss)),
    by = c("kommunenummer", "år")
  ) %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  mutate(
    d_innpend = Innpendlere - lag(Innpendlere),  # årlig endring i innpendling
    g_syss_pct = 100 * (syss / lag(syss) - 1)            # % endring i sysselsetting
  ) %>%
  ungroup()

pendl_syss_diff <- pendl_syss_panel %>%
  filter(is.finite(d_innpend), is.finite(g_syss_pct))

cor_innpend_syss <- pendl_syss_diff %>%
  group_by(kommunenummer) %>%
  summarise(
    n_obs = n(),
    sd_innpend = sd(d_innpend, na.rm = TRUE),
    sd_syss    = sd(g_syss_pct, na.rm = TRUE),
    cor_innpend_syss = {
      if (n_obs >= 2 && sd_innpend > 0 && sd_syss > 0) {
        cor(d_innpend, g_syss_pct, use = 'complete.obs')
      } else {
        NA_real_
      }
    },
    .groups = "drop"
  )

cor_innpend_syss

```

### Demeaning

```{r}
bolig_flytt_lag <- bolig_flytt_panel %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  mutate(
    kvpris_lag1 = lag(kvpris)
  ) %>%
  ungroup()

```

For enkelte relasjoner, som mellom boligpriser og flytting, er det
rimelig å anta at virkninger oppstår med tidsforsinkelser. Vi lager
derfor boligprisene ett år for å ta hensyn til tregheter i
husholdningenes tilpasning.

```{r}
bolig_flytt_dm <- bolig_flytt_lag %>% # Fjerner nivåforskjeller og har kun tidsvariasjon innen kommunen igjen.
  group_by(kommunenummer) %>%
  mutate(
    kvpris_lag1_dm = kvpris_lag1 - mean(kvpris_lag1, na.rm = TRUE),
    nettoflytt_dm  = nettoflytt_per1000 - mean(nettoflytt_per1000, na.rm = TRUE)
  ) %>%
  ungroup()

```

```{r}
cor_bolig_flytt_dm <- bolig_flytt_dm %>%
  filter(is.finite(kvpris_lag1_dm), is.finite(nettoflytt_dm)) %>%
  summarise(
    cor = cor(kvpris_lag1_dm, nettoflytt_dm, use = "complete.obs")
  )

cor_bolig_flytt_dm
```

Demeaning fjerner tidsinvariante kommuneegenskaper som geografisk
beliggenhet, størrelse og historisk sentralitet. Dette gjør at
korrelasjonene i større grad reflekterer samvariasjon over tid innen
samme kommune, snarere enn strukturelle forskjeller mellom kommuner.
Dette er særlig nyttig i paneldata, der en kan risikere uekte
korrelasjoner som er drevet av permanente nivåforskjeller.

## Pearson vs Spearman

Vi har beregnet en Spearman korrelasjonskoeffisient og en Pearson
korrelasjonskoeffsient. Spearman-korrelasjon måler styrken og retningen
til variablene som beveger seg i samme retning, uavhengig av om
sammenhengen er lineær, mens Pearson-korrelasjon måler den lineære
styrken og retningen til variablene mens de beveger seg kontinuerlig. Vi
tar eksempelet mellom sentralitet og kvadratmeterpris.

```{r}
sent_bolig <- kvpris_ene %>% # Gjør klart et datasett for beregningen
  filter(år == 2023) %>%
  left_join(sent_long, by = c("kommunenummer", "år")) %>%
  filter(is.finite(indeks), is.finite(kvpris))

```

```{r}
cor_sent_bolig <- tibble( 
  pearson  = cor(sent_bolig$indeks, sent_bolig$kvpris,
                 method = "pearson", use = "complete.obs"),
  spearman = cor(sent_bolig$indeks, sent_bolig$kvpris,
                 method = "spearman", use = "complete.obs")
) # Beregner ut Pearson og Spearman

cor_sent_bolig

```

Pearson- og Spearman-korrelasjonene er svært like i størrelse (0,715 og
0,710). Dette indikerer at sammenhengen mellom variablene er tilnærmet
lineær, og at resultatet ikke i vesentlig grad påvirkes av uteliggere
eller skjev fordeling. Rangeringen av kommunene samsvarer godt med
nivåforskjellene i variablene, noe som tyder på en stabil og systematisk
samvariasjon.

## Visualisering av noen sammenhenger

```{r}
ggplot( #Plot for sentralitet og bologpris 2023
  kvpris_ene %>%
    filter(år == 2023) %>%
    left_join(sent_long, by = c("kommunenummer", "år")),
  aes(x = indeks, y = kvpris)
) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Sentralitet og boligpriser",
    subtitle = "Eneboliger, 2023",
    x = "Sentralitetsindeks",
    y = "Kvadratmeterpris (kr)"
  ) +
  theme_minimal()

```

Spredningsdiagrammet viser en klart stigende og tilnærmet lineær
sammenheng, noe som støtter bruk av Pearson-korrelasjon.

```{r}
ggplot(
  bolig_flytt_panel %>% filter(år == 2023),
  aes(x = kvpris, y = nettoflytt_per1000)
) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", se = FALSE) +
  labs(
    title = "Boligpriser og nettoflytting",
    subtitle = "2023",
    x = "Kvadratmeterpris (kr)",
    y = "Nettoflytting per 1000 innbyggere"
  ) +
  theme_minimal()

```

Figuren indikerer en monoton, men ikke-lineær sammenheng, med betydelig
spredning. Dette tilsier at Spearman-korrelasjonen gir et mer robust mål
enn Pearson

Korrelasjonskoeffisientene gir kun informasjon om samvariasjon, som er
et statistiks mål på strken og retningen, men kan ikke helt tolke
årsaksbestemmelsen. Sammenhengene kan være påvirket av simultanitet,
utelatte variabler og strukturelle forskjeller mellom kommuner. Videre
kan aggregert kommunedata skjule betydelig intern ulikheter. Resultatene
bør derfor tolkes som deskriptive, og primært brukes som grunnlag for
videre analyse.

## Systematiske forskjeller mellom kommuner i ulike sentralitetskategorier

```{r}
cor_bolig_flytt_by_sentralitet <- bolig_flytt_panel %>%
  left_join(
    Sentralitet %>% select(knr, `Klasse 2023`),
    by = c("kommunenummer" = "knr")
  ) %>%
  group_by(`Klasse 2023`) %>%
  summarise(
    cor = cor(kvpris, nettoflytt_per1000, use = "complete.obs"),
    n = sum(complete.cases(kvpris, nettoflytt_per1000)),
    .groups = "drop"
  )

cor_bolig_flytt_by_sentralitet

```

Korrelasjonsanalysene viser at sammenhengen varierer systematisk mellom
kommuner i ulike sentralitetskategorier. For de fleste
sentralitetsklasser (2–6) er korrelasjonen mellom variablene svak og
svakt positiv. I de mest sentrale kommunene (klasse 1) er sammenhengen
derimot klart negativ. Dette kan indikere at svært høye boligpriser i de
største bykommunene bidrar til å begrense netto innflytting, blant annet
ved at flere husholdninger velger å bosette seg i omlandskommuner og
pendle inn til byene. Samtidig er antall observasjoner i denne gruppen
lavt, noe som tilsier at resultatene bør tolkes med forsiktighet.
Korrelasjonen mellom boligpriser og nettoflytting er sterkere i store
byer enn i distriktskommuner, noe som kan indikere at boligmarkedet
spiller en mer aktiv rolle i flyttebeslutninger i urbane strøk. Videre
kan en forvente at sammenhengene varierer systematisk mellom ulike typer
kommuner, slik de er klassifisert hos Andersson et al. (2020). For
eksempel kan relasjonen mellom sysselsetting, boligpriser og flytting
være sterkere i funksjonelle byregioner enn i perifere
distriktskommuner. Dette gir derimot ikke et helt grunnlag for kausale
tolkninger men kan indikere systematiske samvariasjoner som danner
utgangspunkt for videre analyser og hypoteser.

## Forskjeller mellom kommuner i ulike kategorier hos Andersson et al. (2020)

```{r}
kommune_typologi <- Sentralitet %>%
  select(knr, `Klasse 2023`) %>%
  mutate(
    andersson_type = case_when(
      `Klasse 2023` == 1 ~ "Storbykjerne",
      `Klasse 2023` == 2 ~ "Forstad / omland",
      `Klasse 2023` %in% c(3, 4) ~ "Regionale sentra",
      `Klasse 2023` %in% c(5, 6) ~ "Perifere distrikter"
    )
  )

```

```{r}
bolig_flytt_andersson <- bolig_flytt_panel %>%
  left_join(
    kommune_typologi,
    by = c("kommunenummer" = "knr")
  ) %>%
  filter(!is.na(andersson_type))
```

```{r}
cor_bolig_flytt_andersson <- bolig_flytt_andersson %>%
  group_by(andersson_type) %>%
  summarise(
    cor = cor(kvpris, nettoflytt_per1000, use = "complete.obs"),
    n   = sum(complete.cases(kvpris, nettoflytt_per1000)),
    .groups = "drop"
  )

cor_bolig_flytt_andersson
```

Analysene viser tydelige forskjeller mellom kommuner gruppert etter en
forenklet typologi inspirert av Andersson et al. (2020). For
storbykjerner er korrelasjonen mellom boligpriser og nettoflytting klart
negativ, noe som indikerer at svært høye boligpriser i de største
bykommunene kan virke begrensende på netto innflytting. For regionale
sentra, forstads- og omlandskommuner samt perifere distriktskommuner er
sammenhengen derimot svakt positiv. Dette kan tolkes som at boligpriser
i disse områdene i større grad reflekterer attraktivitet og
etterspørsel, uten de samme kapasitetsbegrensningene som i
storbykjerner. Her er også antall observasjoner for storbykjerner
relativt lavt, noe som tilsier at resultatene bør tolkes med en viss
varsomhet. Resultatene understøtter dermed antakelsen om at sammenhenger
mellom boligmarked og flytteprosesser varierer systematisk med
kommunenes funksjonelle rolle i det regionale systemet.

## Sammenhengen mellom befolkning og sysselsetting

```{r}
# Dette konstruerer et paneldatasett på formen (kommunenummer, år, befolkning, sysselsetting).
# Siden datakildene dekker ulike år, avgrenses utvalget automatisk til observasjoner som finnes i begge.

panel_bef_syss <- demografi_total %>%
  # Standardiser nøkkelvariabler (kommunenummer som 4-sifret streng og år som heltall)
  mutate(
    kommunenummer = stringr::str_pad(as.character(kommunenummer), 4, "left", "0"),
    år = as.integer(år)
  ) %>%
  # Aggreger til total befolkning per kommune og år (summerer over aldersgrupper)
  group_by(kommunenummer, år) %>%
  summarise(
    befolkning = sum(bef, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Koble på sysselsetting fra syss (arbeidssted) uten å lagre mellomdatasett
  left_join(
    syss %>%
      mutate(
        kommunenummer = stringr::str_pad(as.character(kommunenummer), 4, "left", "0"),
        år = as.integer(år),
        sysselsetting = Arbeidssted
      ) %>%
      select(kommunenummer, år, sysselsetting),
    by = c("kommunenummer", "år")
  ) %>%
  # Beholder kun kommune-år som finnes i begge datakilder (implisitt felles år) og som har gyldige verdier
  filter(
    !is.na(befolkning),
    !is.na(sysselsetting)
  )

```

```{r}
# Pooled regresjon (uten kommune- og årsspesifikasjon)

# Konstruerer et paneldatasett på kommune-år-nivå (kommunenummer, år, befolkning, sysselsetting).
# Utvalget begrenses til kommune-år-observasjoner som finnes i begge datakilder.

m_pooled <- lm(sysselsetting ~ befolkning, data = panel_bef_syss)
```

```{r}
# Regresjon med faste effekter for både kommune og år (two-way fixed effects)

# Kommune-faste effekter kontrollerer for tidinvariante kommuneegenskaper, mens år-faste effekter kontrollerer for felles nasjonale sjokk og trender. Standardfeil er klustret på kommunenivå.

m_fe <- fixest::feols(
  sysselsetting ~ befolkning | kommunenummer + år,
  data = panel_bef_syss,
  cluster = ~ kommunenummer
)

```

```{r}
# Tabellen sammenligner koeffisienten til befolkning i pooled-modellen og i FE-modellen.
# Dette gjør det enkelt å se hvordan kontroll for kommune- og årsfaste effekter påvirker estimatet.

modelsummary(
  list(
    "Pooled OLS" = m_pooled,
    "Kommune + år FE" = m_fe
  ),
  stars = TRUE,
  statistic = "({std.error})",
  gof_omit = "IC|Log|Adj|F|RMSE"
)

```

Sammenlign resultatene for disse to regresjonsmodellene:

I den pooled regresjonen er sysselsetting den avhengige variabelen og
befolkning forklaringsvariabelen. Modellen skiller ikke mellom kommuner
og år, men behandler alle kommune-år-observasjoner samlet. Estimatet
utnytter derfor både forskjeller mellom kommuner og endringer innen
samme kommune over tid for å beskrive sammenhengen mellom befolkning og
sysselsetting. Koeffisienten på 0,696 innebærer at en økning i
befolkningen på en person i gjennomsnitt er assosiert med om lag 0,696
flere sysselsatte.

Når faste effekter for både kommuner og år inkluderes, kontrollerer
modellen for kommune-spesifikke faktorer som er konstante over tid, samt
felles nasjonale sjokk i hvert år. I denne spesifikasjonen identifiseres
sammenhengen mellom befolkning og sysselsetting utelukkende ved hjelp av
variasjon innen samme kommune over tid. Koeffisienten på 0,601 innebærer
at en økning i befolkningen på en person innen en kommune i gjennomsnitt
er assosiert med om lag 0,601 flere sysselsatte.

At koeffisienten i modellen med faste effekter er lavere enn i den
pooled regresjonen, indikerer at en del av den positive sammenhengen i
pooled modellen skyldes varige strukturelle forskjeller mellom kommuner
som kontrolleres for når faste effekter inkluderes.

Sammenlign med resultater for korrelasjonskoeﬀisienter i deloppgaven
foran:

Kan resultatene fra slike regresjonsmodeller i større grad enn
korrelasjonskoeﬀisienten tolkes kausalt?

Resultatene fra regresjonsmodellene kan i større grad enn en enkel
korrelasjonskoeffisient tolkes kausalt. En korrelasjonskoeffisient viser
kun om to variabler samvarierer. Den kontrollerer ikke for andre
forhold. Regresjonsmodellene kontrollerer derimot for flere viktige
faktorer. Når faste effekter for kommuner og år inkluderes, tas det
hensyn til både varige forskjeller mellom kommuner og felles sjokk som
rammer alle kommuner i samme år. Estimatene bygger da på endringer innen
samme kommune over tid. Dette gir et bedre grunnlag for kausal tolkning.
Likevel kan resultatene ikke tolkes som fullt ut kausale. Det kan
fortsatt finnes omvendt kausalitet og tidsvarierende forhold som ikke er
kontrollert for i modellen.

## Relevante hypoteser basert på deskriptiv statistikk

## En multippel regresjonsmodell for folketallsutvikling

```{r}
# Kommunenummer -> fylkesnummer -> landsdel
# Forsøk også å ta innen dummyvariabel for landsdel (for eksempel sør, vest, øst, nord, og Trøndelag)
add_landsdel <- function(df, knr = kommunenummer) {
  df %>%
    mutate(
      fylke = as.integer(substr(!!rlang::ensym(knr), 1, 2)),
      landsdel = case_when(
        fylke %in% c(3, 31, 32, 33, 34) ~ "øst", # Øst: Oslo + Østfold/Akershus/Buskerud/Innlandet
        fylke %in% c(39, 40, 42) ~ "sør",        # Sør: Vestfold/Telemark/Agder
        fylke %in% c(11, 46, 15) ~ "vest",       # Vest: Rogaland/Vestland/Møre og Romsdal
        fylke %in% c(50) ~ "Trøndelag",          # Trøndelag
        fylke %in% c(18, 55, 56) ~ "nord",       # Nord: Nordland/Troms/Finnmark
        TRUE ~ NA_character_
      ), landsdel = factor(landsdel, levels = c("øst", "sør", "vest", "Trøndelag", "nord")))}

# Fastsetter sentralitetsindeksen til verdien i 2023 (anbefalt som tilnærmet tidsinvariant mål)
sent_fixed <- sent_long %>%
  filter(år == 2023) %>%
  select(kommunenummer, sentralitet = indeks)
```

```{r}
# Samler alle variablene som brukes i oppgaven i datasettet df_6 før estimering av regresjonsmodell
df_6 <- andel_20_29 %>%
  transmute(
    kommunenummer = stringr::str_pad(as.character(kommunenummer), 4, "left", "0"),
    år = as.integer(år), folketall, andel_20_29) %>%
  add_landsdel(kommunenummer) %>% 
  left_join(sent_fixed, by = "kommunenummer") %>%   
  left_join(ledig %>% rename(arbeidsledighet_pct = ledig), by = c("kommunenummer", "år")) %>%
  left_join(andel_hoyere %>% rename(hoyere_utdanning_andel = andel_hoyere), by = c("kommunenummer", "år")) %>%
  left_join(pendl_std %>% 
              select(kommunenummer, år, nettopend) %>%
              rename(netto_innpendling_per1000 = nettopend), by = c("kommunenummer", "år")) %>%
  left_join(flytt_std %>%
              select(kommunenummer, år, nettoflytt_per1000) %>%
              mutate(netto_utflytting_per1000 = -nettoflytt_per1000) %>%
              select(-nettoflytt_per1000), by = c("kommunenummer", "år")) %>%
  left_join(kvpris_ene %>% select(kommunenummer, år, kvpris), by = c("kommunenummer", "år")) %>%
  left_join(syss %>%
      mutate(kommunenummer = stringr::str_pad(as.character(kommunenummer), 4, "left", "0"), år = as.integer(år)) %>%
      transmute(kommunenummer, år, sysselsetting = Arbeidssted), by = c("kommunenummer", "år")) %>%
  mutate(
    sysselsetting_per1000 = 1000 * sysselsetting / folketall,
    ln_boligpris = if_else(is.finite(kvpris) & kvpris > 0, log(kvpris), NA_real_)
  )

```

### Start-år-modell

```{r}
# Forklaringsvariabler som inngår i modellen
x_cols <- c("sentralitet","arbeidsledighet_pct","hoyere_utdanning_andel",
            "sysselsetting_per1000","netto_innpendling_per1000",
            "netto_utflytting_per1000","ln_boligpris","andel_20_29")

# Identifiserer det tidligste året med komplette observasjoner for hver kommune
df_6_startyear <- df_6 %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  summarise(
    start_år = suppressWarnings(min(år[complete.cases(across(all_of(c("folketall", x_cols))))])),
    end_år   = suppressWarnings(max(år[is.finite(folketall)])),
    .groups = "drop"
  ) %>%
  filter(is.finite(start_år), is.finite(end_år), start_år < end_år)

# Henter forklaringsvariabler og folketall fra startåret
df_6_X_start <- df_6 %>%
  inner_join(df_6_startyear, by = "kommunenummer") %>%
  filter(år == start_år) %>%
  select(kommunenummer, landsdel, start_år, folketall_start = folketall, all_of(x_cols))

# Henter folketall fra sluttåret
df_6_y_end <- df_6 %>%
  inner_join(df_6_startyear, by = "kommunenummer") %>%
  filter(år == end_år) %>%
  select(kommunenummer, end_år, folketall_end = folketall)

# Konstruerer tverrsnittsdatasett og beregner samlet folketallsvekst
df_6_csA <- df_6_X_start %>%
  inner_join(df_6_y_end, by = "kommunenummer") %>%
  mutate(
    folketallsvekst = 100 * (folketall_end - folketall_start) / folketall_start
  ) %>%
  filter(is.finite(folketallsvekst)) %>%
  filter(complete.cases(across(all_of(c("folketallsvekst", x_cols, "landsdel")))))

# Modell A: forklaringsvariabler målt i startåret
m_6A <- lm(
  folketallsvekst ~ sentralitet + arbeidsledighet_pct + hoyere_utdanning_andel +
    sysselsetting_per1000 + netto_innpendling_per1000 + netto_utflytting_per1000 +
    ln_boligpris + andel_20_29 + factor(landsdel),
  data = df_6_csA
)
summary(m_6A)

# Denne modellen er en start-år-modell
# start_år angir det tidligste året med komplette forklaringsvariabler for hver kommune
# end_år angir det siste året med tilgjengelige folketall
# Den avhengige variabelen er kommunens samlede prosentvise folketallsvekst over hele observasjonsperioden
# Alle forklaringsvariabler er målt i startåret
# Sentralitet er representert ved verdien i 2023 som et tilnærmet tidsinvariant strukturelt mål
# Øst fungerer som referansekategori for landsdel
# Koeffisientene for øvrige landsdeler viser gjennomsnittlige forskjeller relativt til Østlandet,
# kontrollert for øvrige forklaringsvariabler
```

### Periode-gjennomsnitt-modell

```{r}
# Beregner periodegjennomsnitt for forklaringsvariablene
# For hver kommune tas gjennomsnittet av hver forklaringsvariabel
# over hele observasjonsperioden, fra start_år til end_år.
# Denne tilnærmingen fanger opp kommunens langsiktige, gjennomsnittlige
# strukturelle kjennetegn, snarere enn nivået i et enkelt år.

df_6_X_mean <- df_6 %>%
  inner_join(df_6_startyear, by = "kommunenummer") %>%
  filter(år >= start_år, år <= end_år) %>%
  group_by(kommunenummer, start_år, end_år) %>%
  summarise(
    across(all_of(x_cols), ~ mean(.x, na.rm = TRUE)),
    landsdel = first(landsdel), 
    folketall_start = first(folketall[år == start_år]),
    .groups = "drop"
  )

# Konstruerer tverrsnittsdatasett for modell B ved å kombinere
# periodegjennomsnittlige forklaringsvariabler med folketall i sluttåret
df_6_csB <- df_6_X_mean %>%
  inner_join(df_6_y_end, by = "kommunenummer") %>%
  mutate(
    folketallsvekst = 100 * (folketall_end - folketall_start) / folketall_start
  ) %>%
  filter(is.finite(folketallsvekst)) %>%
  filter(complete.cases(across(all_of(c("folketallsvekst", x_cols, "landsdel")))))

# Modell B: periode-gjennomsnitt-modell
# Forklaringsvariablene representerer gjennomsnittlige nivåer
# over hele observasjonsperioden for hver kommune
m_6B <- lm(
  folketallsvekst ~ sentralitet + arbeidsledighet_pct + hoyere_utdanning_andel +
    sysselsetting_per1000 + netto_innpendling_per1000 + netto_utflytting_per1000 +
    ln_boligpris + andel_20_29 + landsdel,
  data = df_6_csB
)
summary(m_6B)

# Den avhengige variabelen er kommunens samlede prosentvise folketallsvekst, identisk definert som i modell A.
# Forklaringsvariablene er definert som gjennomsnitt over perioden fra start_år til end_år, og reflekterer langsiktige strukturelle forhold.
# Sentralitet er representert ved verdien i 2023 og er konstant over perioden, slik at periodegjennomsnittet tilsvarer denne faste verdien.
# Denne modellformuleringen kan tolkes som en sammenheng mellom kommunens gjennomsnittlige kjennetegn og langsiktig befolkningsutvikling, men gir ikke grunnlag for kausale tolkninger.

```

### FE-modell

```{r}
# Paneldataanalyse med faste effekter (Fixed Effects)

# Konstruerer årlig befolkningsvekst som log-differanse
# Log-differansen i folketall mellom to påfølgende år
# kan tolkes som tilnærmet prosentvis årlig befolkningsvekst.
df_6_fe <- df_6 %>%
  mutate(
    kommunenummer = stringr::str_pad(as.character(kommunenummer), 4, "left", "0"),
    år = as.integer(år),
    folketall = as.numeric(folketall)
  ) %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  mutate(
    dlog_folketall = log(folketall) - lag(log(folketall))
  ) %>%
  ungroup() %>%
  # Fjerner første observasjonsår per kommune (der lag er udefinert),
  # samt observasjoner med ugyldige log-verdier
  filter(is.finite(dlog_folketall)) %>%
  # Beholder kun observasjoner der alle forklaringsvariabler
  # som inngår i FE-modellen er observert
  filter(
    complete.cases(
      dlog_folketall,
      arbeidsledighet_pct,
      hoyere_utdanning_andel,
      sysselsetting_per1000,
      netto_innpendling_per1000,
      netto_utflytting_per1000,
      ln_boligpris,
      andel_20_29
    )
  )

# Two-way Fixed Effects-modell: kommune- og årsfaste effekter
# Modellen inkluderer faste effekter for både kommuner og år,
# og utnytter dermed kun variasjon innen samme kommune over tid.
# Standardfeil klustreres på kommunenivå for å ta hensyn til
# serial korrelasjon og heteroskedastisitet innen kommuner.
m_6FE <- feols(
  dlog_folketall ~ arbeidsledighet_pct + hoyere_utdanning_andel +
    sysselsetting_per1000 + netto_innpendling_per1000 + netto_utflytting_per1000 +
    ln_boligpris + andel_20_29
  | kommunenummer + år,
  data = df_6_fe,
  cluster = ~ kommunenummer
)
summary(m_6FE)

# FE-modellen utnytter kun variasjon innen samme kommune over tid og identifiserer hvordan årlige endringer i forklaringsvariablene samvarierer med årlig befolkningsvekst.
# Tidsinvariante forhold som sentralitet og landsdel fanges opp av kommune-faste effekter og kan derfor ikke estimeres eksplisitt.
# Sammenlignet med tverrsnittsmodellene (modell A og B) mister flere variabler statistisk signifikans i FE-modellen. Dette er forventet og reflekterer at FE-modellen kontrollerer for uobserverte, tid-invariante forskjeller mellom kommuner.
# Netto utflytting per 1000 innbyggere har en negativ og signifikant sammenheng med årlig befolkningsvekst innen samme kommune.
# Andel 20–29 år har en positiv og signifikant sammenheng med årlig befolkningsvekst innen kommuner.
```

## En multippel regresjonsmodell for sysselsettingsvekst

### Start-år-modell

```{r}
# Modell A (start-år): sysselsettingsvekst som avhengig variabel

# Finn start- og sluttår per kommune (krever at både X, folketall og sysselsetting finnes)
df_7_startyear <- df_6 %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  summarise(
    # start_år: tidligste år der alle X + folketall + sysselsetting er tilgjengelig
    start_år = suppressWarnings(min(år[
      complete.cases(across(all_of(c(x_cols, "folketall", "sysselsetting"))))
    ])),
    # end_år: siste år der både folketall og sysselsetting finnes
    end_år = suppressWarnings(max(år[is.finite(folketall) & is.finite(sysselsetting)])),
    .groups = "drop"
  ) %>%
  filter(is.finite(start_år), is.finite(end_år), start_år < end_år)

# Hent forklaringsvariabler fra startåret + startverdier for folketall og sysselsetting
df_7_X_start <- df_6 %>%
  inner_join(df_7_startyear, by = "kommunenummer") %>%
  filter(år == start_år) %>%
  select(
    kommunenummer, landsdel, start_år,
    folketall_start = folketall,
    syss_start = sysselsetting,
    all_of(x_cols)
  )

# Hent sluttverdier (end_år) for folketall og sysselsetting
df_7_end <- df_6 %>%
  inner_join(df_7_startyear, by = "kommunenummer") %>%
  filter(år == end_år) %>%
  select(
    kommunenummer, end_år,
    folketall_end = folketall,
    syss_end = sysselsetting
  )

# Konstruer tverrsnitt: beregn samlet sysselsettingsvekst (Y) og folketallsvekst (ny X)
df_7_csA <- df_7_X_start %>%
  inner_join(df_7_end, by = "kommunenummer") %>%
  mutate(
    # Avhengig variabel: samlet prosentvis sysselsettingsvekst
    sysselsettingsvekst = 100 * (syss_end - syss_start) / syss_start,
    # Ny forklaringsvariabel: samlet prosentvis folketallsvekst
    folketallsvekst = 100 * (folketall_end - folketall_start) / folketall_start
  ) %>%
  filter(is.finite(sysselsettingsvekst), is.finite(folketallsvekst)) %>%
  filter(complete.cases(across(all_of(c("sysselsettingsvekst", "folketallsvekst", x_cols, "landsdel")))))


# Modell 7A: Start-år-modell (tverrsnitt)
m_7A <- lm(
  sysselsettingsvekst ~ folketallsvekst + sentralitet + arbeidsledighet_pct +
    hoyere_utdanning_andel + sysselsetting_per1000 + netto_innpendling_per1000 +
    netto_utflytting_per1000 + ln_boligpris + andel_20_29 + factor(landsdel),
  data = df_7_csA
)

summary(m_7A)

# Dette er en tverrsnittmodell der sysselsettingsvekst over hele perioden er avhengig variabel.
# Forklaringsvariablene (unntatt folketallsvekst) måles i startåret.
# Folketallsvekst inkluderes som egen forklaringsvariabel (vekstrate over hele perioden).
# Sentralitet er representert ved 2023-verdien (tilnærmet tidsinvariant).
# Øst er referansekategori for landsdel (via factor(landsdel)).

```

### Periode-gjennomsnitt-modell

```{r}
# Modell B (periode-gjennomsnitt): sysselsettingsvekst som avhengig variabel

# Finn start- og sluttår per kommune (krever at folketall og sysselsetting finnes)
df_7_startyear <- df_6 %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  summarise(
    # start_år: tidligste år der alle X + folketall + sysselsetting er tilgjengelig
    start_år = suppressWarnings(min(år[
      complete.cases(across(all_of(c(x_cols, "folketall", "sysselsetting"))))
    ])),
    # end_år: siste år der både folketall og sysselsetting finnes
    end_år = suppressWarnings(max(år[is.finite(folketall) & is.finite(sysselsetting)])),
    .groups = "drop"
  ) %>%
  filter(is.finite(start_år), is.finite(end_år), start_år < end_år)

# Periodegjennomsnitt for forklaringsvariablene (mellom start_år og end_år)
# Samtidig hentes folketall_start og syss_start fra start_år.
df_7_X_mean <- df_6 %>%
  inner_join(df_7_startyear, by = "kommunenummer") %>%
  filter(år >= start_år, år <= end_år) %>%
  group_by(kommunenummer, start_år, end_år) %>%
  summarise(
    across(all_of(x_cols), ~ mean(.x, na.rm = TRUE)), 
    landsdel = first(landsdel),
    folketall_start = first(folketall[år == start_år]),
    syss_start      = first(sysselsetting[år == start_år]),
    .groups = "drop"
  )

# 3) Sluttverdier (end_år) for folketall og sysselsetting
df_7_y_end <- df_6 %>%
  inner_join(df_7_startyear, by = "kommunenummer") %>%
  filter(år == end_år) %>%
  select(
    kommunenummer, end_år,
    folketall_end = folketall,
    syss_end      = sysselsetting
  )

# 4) Tverrsnittsdatasett + beregning av vekstrater (Y og ny X)
df_7_csB <- df_7_X_mean %>%
  inner_join(df_7_y_end, by = "kommunenummer") %>%
  mutate(
    # Avhengig variabel: samlet prosentvis sysselsettingsvekst
    sysselsettingsvekst = 100 * (syss_end - syss_start) / syss_start,
    # Ny forklaringsvariabel: samlet prosentvis folketallsvekst
    folketallsvekst     = 100 * (folketall_end - folketall_start) / folketall_start
  ) %>%
  filter(is.finite(sysselsettingsvekst), is.finite(folketallsvekst)) %>%
  filter(complete.cases(across(all_of(c("sysselsettingsvekst","folketallsvekst", x_cols, "landsdel")))))


# 5) Modell 7B: Periode-gjennomsnitt-modell (tverrsnitt)
m_7B <- lm(
  sysselsettingsvekst ~ folketallsvekst + sentralitet + arbeidsledighet_pct +
    hoyere_utdanning_andel + sysselsetting_per1000 + netto_innpendling_per1000 +
    netto_utflytting_per1000 + ln_boligpris + andel_20_29 + factor(landsdel),
  data = df_7_csB
)

summary(m_7B)


# Modell B bruker periodegjennomsnitt av forklaringsvariabler (start_år–end_år).
# Sysselsettingsvekst er samlet vekst fra start_år til end_år.
# Folketallsvekst inkluderes som egen forklaringsvariabel (samme periode).
# Sentralitet er i praksis tidsinvariant (fast 2023-verdi), og gjennomsnittet tilsvarer denne.

```

### FE-modell

```{r}
# Paneldata FE (two-way): sysselsettingsvekst som avhengig variabel

df_7_fe <- df_6 %>%
  mutate(
    kommunenummer = stringr::str_pad(as.character(kommunenummer), 4, "left", "0"),
    år = as.integer(år),
    folketall = as.numeric(folketall),
    sysselsetting = as.numeric(sysselsetting)
  ) %>%
  arrange(kommunenummer, år) %>%
  group_by(kommunenummer) %>%
  mutate(
    # Årlig vekst: log-differanse (tilnærmet prosentvis vekst)
    dlog_sysselsetting = log(sysselsetting) - lag(log(sysselsetting)),
    dlog_folketall     = log(folketall)     - lag(log(folketall))
  ) %>%
  ungroup() %>%
  # Fjerner første år per kommune + ugyldige log-verdier
  filter(is.finite(dlog_sysselsetting), is.finite(dlog_folketall)) %>%
  # Beholder kun rader der alle forklaringsvariabler i FE-modellen er observert
  filter(
    complete.cases(
      arbeidsledighet_pct,
      hoyere_utdanning_andel,
      sysselsetting_per1000,
      netto_innpendling_per1000,
      netto_utflytting_per1000,
      ln_boligpris,
      andel_20_29
    )
  )

# Two-way FE: kommune + år, standardfeil klustrert på kommune
m_7FE <- feols(
  dlog_sysselsetting ~ dlog_folketall + arbeidsledighet_pct + hoyere_utdanning_andel +
    sysselsetting_per1000 + netto_innpendling_per1000 + netto_utflytting_per1000 +
    ln_boligpris + andel_20_29
  | kommunenummer + år,
  data = df_7_fe,
  cluster = ~ kommunenummer
)
summary(m_7FE)

# Avhengig variabel er årlig sysselsettingsvekst, målt som log-differanse i sysselsetting.
# I tråd med oppgaveteksten inngår befolkningsutvikling som forklaringsvariabel, representert ved årlig log-differanse i folketall.
# Modellen inkluderer kommune- og årsfaste effekter og utnytter kun variasjon innen samme kommune over tid.
# Tidsinvariante forhold som sentralitet og landsdel fanges dermed opp av kommune-faste effekter.
# Standardfeil er klustrert på kommunenivå.

```

# Konklusjoner og diskusjon

# Litteraturliste

::: {#refs}
:::

\listoffigures
\listoftables
